<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>√Örshjul</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    line-height: 1.5;
    margin: 2rem;
  }

  h1 {
    margin-bottom: 1.25rem;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1.25rem;
  }

  .controls button,
  .controls select {
    font: inherit;
  }

  /* Months list */
  section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ddd;
  }

  h2 {
    margin-bottom: 0.5rem;
  }

  ul {
    margin: 0;
    padding-left: 1.2rem;
  }

  li {
    margin-bottom: 0.3rem;
  }

  .day-item {
    all: unset;
    display: grid;
    grid-template-columns: 2.5em 1.8em auto;
    align-items: center;
    width: 100%;
    cursor: pointer;
  }

  .day {
    min-width: 2em;
    display: inline-block;
  }

  .icon {
    width: 1.8em;
    text-align: center;
  }

  /* Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .overlay-content {
    background: white;
    padding: 1.5rem;
    max-width: 420px;
    width: 90%;
    border-radius: 8px;
  }

  .hidden {
    display: none;
  }

  /* ===== OVERVIEW MODE (aktiveras senare med JS) ===== */
  #overview {
    display: none;
    margin-top: 1rem;
  }

  body.overview-mode #months {
    display: none;
  }

  body.overview-mode #overview {
    display: block;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (max-width: 900px) {
    .overview-grid {
      grid-template-columns: 1fr;
    }
  }

  .overview-month {
    border: 1px solid #eee;
    padding: 0.75rem;
    border-radius: 8px;
  }

  .overview-month h2 {
    margin: 0 0 0.4rem 0;
    font-size: 1.1rem;
  }

  .overview-month ul {
    padding-left: 1.1rem;
  }

  .overview-month li {
    margin-bottom: 0.2rem;
  }

  /* D√∂lj √•lder i normal vy */
  .age {
    display: none !important;
  }

/* D√∂lj print-vyn i normalvy */
#printMeta,
#printWrap {
  display: none;
}

/* ===== PRINT ===== */
@media print {

  /* D√∂lj kontroller + overlay + originalvyn (vi skriver ut print-wrappern i st√§llet) */
  .controls,
  #overview,
  #overlay,
  #months {
    display: none !important;
  }

  /* Visa print-wrappern */
  #printMeta {
    display: block !important;
  }

  #printWrap {
    display: flex !important;
  }

  /* Bas f√∂r sidan (st√∂rre text, men h√•ll 1 sida) */
  body {
    font-size: 12.5pt !important;
    line-height: 1.25 !important;
    margin: 10mm !important;
  }

  h1 {
    font-size: 18pt !important;
    margin: 0 0 2mm 0 !important;
  }

  /* Tydlig rad med valt √•r */
  #printMeta {
    font-size: 12.5pt !important;
    margin: 0 0 6mm 0 !important;
  }

  /* Tv√• kolumner */
  #printWrap {
    gap: 14mm;
    align-items: flex-start;
  }

  .print-col {
    flex: 1 1 0;
    min-width: 0;
  }

  /* M√•nadskort i print */
  .print-month {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  .print-month h2 {
    margin: 0 0 2.5mm 0 !important;
    font-size: 14pt !important;
  }

  .print-month ul {
    margin: 0 !important;
    padding-left: 0 !important;
    list-style: none !important;
  }

  .print-month li {
    margin: 0 0 1.75mm 0 !important;
  }

  hr {
    display: none !important;
  }
}

</style>
  
</head>
<body>

<h1>√Örshjul</h1>

<div class="controls">
  <button id="printBirthdaysBtn" type="button">
    Skriv ut ‚Äì endast f√∂delsedagar
  </button>
  <button id="copyBirthdaysBtn" type="button">Kopiera f√∂delsedagslista</button>

  <button id="toggleOverviewBtn" type="button">
    Visa √∂versikt
  </button>

  <label class="year-control" for="yearSelect">√Ör:</label>
  <select id="yearSelect" class="year-control" aria-label="V√§lj √•r"></select>
</div>

<!-- Print-only (byggs av JS precis innan utskrift) -->
<div id="printMeta" class="print-only"></div>
<div id="printWrap" class="print-only"></div>

<main id="months">

<section data-month="januari">

  <h2>Januari</h2>
  <ul>

  <li>
  <button
    class="day-item"
    data-day="3"
    data-month="januari"
    data-type="birthday"
    data-year="1947"
    data-name="Lars"
    type="button"
  >
    <span class="day">3</span>
    <span class="icon">üéÇ</span>
    <span class="text">Lars</span>
<span class="age"></span>
  </button>
</li>
 
  </ul>
</section>

<section data-month="februari">
  <h2>Februari</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="6"
        data-month="februari"
        data-type="birthday"
        data-year="2009"
        data-name="Sophie"
        type="button"
      >
        <span class="day">6</span>
        <span class="icon">üéÇ</span>
        <span class="text">Sophie</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

  <section data-month="mars">
  <h2>Mars</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="10"
        data-month="mars"
        data-type="birthday"
        data-year="2006"
        data-name="Theodor"
        type="button"
      >
        <span class="day">10</span>
        <span class="icon">üéÇ</span>
        <span class="text">Theodor</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="12"
        data-month="mars"
        data-type="birthday"
        data-year="2013"
        data-name="Milton"
        type="button"
      >
        <span class="day">12</span>
        <span class="icon">üéÇ</span>
        <span class="text">Milton</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="15"
        data-month="mars"
        data-type="birthday"
        data-year="1986"
        data-name="Linda"
        type="button"
      >
        <span class="day">15</span>
        <span class="icon">üéÇ</span>
        <span class="text">Linda</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="16"
        data-month="mars"
        data-type="birthday"
        data-year="1989"
        data-name="Mathilda"
        type="button"
      >
        <span class="day">16</span>
        <span class="icon">üéÇ</span>
        <span class="text">Mathilda</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="17"
        data-month="mars"
        data-type="birthday"
        data-year="1976"
        data-name="David"
        type="button"
      >
        <span class="day">17</span>
        <span class="icon">üéÇ</span>
        <span class="text">David</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="april">
  <h2>April</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="maj">
  <h2>Maj</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="14"
        data-month="maj"
        data-type="birthday"
        data-year="2013"
        data-name="Myra"
        type="button"
      >
        <span class="day">14</span>
        <span class="icon">üéÇ</span>
        <span class="text">Myra</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="18"
        data-month="maj"
        data-type="birthday"
        data-year="1981"
        data-name="Emanuel"
        type="button"
      >
        <span class="day">18</span>
        <span class="icon">üéÇ</span>
        <span class="text">Emanuel</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="juni">
  <h2>Juni</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="juli">
  <h2>Juli</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="30"
        data-month="juli"
        data-type="birthday"
        data-year="2025"
        data-name="Isabelle"
        type="button"
      >
        <span class="day">30</span>
        <span class="icon">üéÇ</span>
        <span class="text">Isabelle</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="augusti">
  <h2>Augusti</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="3"
        data-month="augusti"
        data-type="birthday"
        data-year="2007"
        data-name="Leo"
        type="button"
      >
        <span class="day">3</span>
        <span class="icon">üéÇ</span>
        <span class="text">Leo</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="7"
        data-month="augusti"
        data-type="birthday"
        data-year="1987"
        data-name="Martin"
        type="button"
      >
        <span class="day">7</span>
        <span class="icon">üéÇ</span>
        <span class="text">Martin</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="30"
        data-month="augusti"
        data-type="birthday"
        data-year="2007"
        data-name="Tristan"
        type="button"
      >
        <span class="day">30</span>
        <span class="icon">üéÇ</span>
        <span class="text">Tristan</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="september">
  <h2>September</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="1"
        data-month="september"
        data-type="birthday"
        data-year="2005"
        data-name="Max"
        type="button"
      >
        <span class="day">1</span>
        <span class="icon">üéÇ</span>
        <span class="text">Max</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="4"
        data-month="september"
        data-type="birthday"
        data-year="1982"
        data-name="Charlotte"
        type="button"
      >
        <span class="day">4</span>
        <span class="icon">üéÇ</span>
        <span class="text">Charlotte</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="25"
        data-month="september"
        data-type="birthday"
        data-year="1978"
        data-name="Victor"
        type="button"
      >
        <span class="day">25</span>
        <span class="icon">üéÇ</span>
        <span class="text">Victor</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="oktober">
  <h2>Oktober</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="november">
  <h2>November</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="6"
        data-month="november"
        data-type="birthday"
        data-year="1971"
        data-name="Nina"
        type="button"
      >
        <span class="day">6</span>
        <span class="icon">üéÇ</span>
        <span class="text">Nina</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="14"
        data-month="november"
        data-type="birthday"
        data-year="1968"
        data-name="Jennie"
        type="button"
      >
        <span class="day">14</span>
        <span class="icon">üéÇ</span>
        <span class="text">Jennie</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="29"
        data-month="november"
        data-type="birthday"
        data-year="1973"
        data-name="Calle"
        type="button"
      >
        <span class="day">29</span>
        <span class="icon">üéÇ</span>
        <span class="text">Calle</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="december">
  <h2>December</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="5"
        data-month="december"
        data-type="birthday"
        data-year="2019"
        data-name="Mila"
        type="button"
      >
        <span class="day">5</span>
        <span class="icon">üéÇ</span>
        <span class="text">Mila</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="9"
        data-month="december"
        data-type="birthday"
        data-year="1949"
        data-name="Ann"
        type="button"
      >
        <span class="day">9</span>
        <span class="icon">üéÇ</span>
        <span class="text">Ann</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="20"
        data-month="december"
        data-type="birthday"
        data-year="1978"
        data-name="Frida"
        type="button"
      >
        <span class="day">20</span>
        <span class="icon">üéÇ</span>
        <span class="text">Frida</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

</main>

<!-- Overview (visas n√§r body har klassen overview-mode) -->
<div id="overview">
  <div class="overview-grid" id="overviewGrid"></div>
</div>

<div id="overlay" class="overlay hidden">

  <div class="overlay-content">
    <button id="closeOverlay">St√§ng √ó</button>
    <h2 id="overlayTitle">Februari</h2>
    <p id="overlayText">H√§r ska informationen om februari visas.</p>
  </div>
</div>

<script>
const App = {
  /* =========================
     0. STATE
  ========================= */
  currentYear: new Date().getFullYear(),
  selectedYear: null,
  _isPreparingPrint: false,

  monthOrder: [
    "januari",
    "februari",
    "mars",
    "april",
    "maj",
    "juni",
    "juli",
    "augusti",
    "september",
    "oktober",
    "november",
    "december"
  ],

  selectors: {
    monthSections: "#months > section",
    birthdayButtons: '.day-item[data-type="birthday"]'
  },

  // FAS 4: datak√§lla
  events: [
    { type: "birthday", day: 3, month: "januari", year: 1947, name: "Lars" },
    { type: "birthday", day: 6, month: "februari", year: 2009, name: "Sophie" },

    { type: "birthday", day: 10, month: "mars", year: 2006, name: "Theodor" },
    { type: "birthday", day: 12, month: "mars", year: 2013, name: "Milton" },
    { type: "birthday", day: 15, month: "mars", year: 1986, name: "Linda" },
    { type: "birthday", day: 16, month: "mars", year: 1989, name: "Mathilda" },
    { type: "birthday", day: 17, month: "mars", year: 1976, name: "David" },

    { type: "birthday", day: 14, month: "maj", year: 2013, name: "Myra" },
    { type: "birthday", day: 18, month: "maj", year: 1981, name: "Emanuel" },

    { type: "birthday", day: 30, month: "juli", year: 2025, name: "Isabelle" },

    { type: "birthday", day: 3, month: "augusti", year: 2007, name: "Leo" },
    { type: "birthday", day: 7, month: "augusti", year: 1987, name: "Martin" },
    { type: "birthday", day: 30, month: "augusti", year: 2007, name: "Tristan" },

    { type: "birthday", day: 1, month: "september", year: 2005, name: "Max" },
    { type: "birthday", day: 4, month: "september", year: 1982, name: "Charlotte" },
    { type: "birthday", day: 25, month: "september", year: 1978, name: "Victor" },

    { type: "birthday", day: 6, month: "november", year: 1971, name: "Nina" },
    { type: "birthday", day: 14, month: "november", year: 1968, name: "Jennie" },
    { type: "birthday", day: 29, month: "november", year: 1973, name: "Calle" },

    { type: "birthday", day: 5, month: "december", year: 2019, name: "Mila" },
    { type: "birthday", day: 9, month: "december", year: 1949, name: "Ann" },
    { type: "birthday", day: 20, month: "december", year: 1978, name: "Frida" }
  ],

  /* =========================
     1. DOM REFERENCES
  ========================= */
  dom: {
    overlay: null,
    overlayTitle: null,
    overlayText: null,
    closeBtn: null,
    printBtn: null,
    copyBtn: null,
    openSound: null,
    yearSelect: null,
    toggleOverviewBtn: null,
    overviewGrid: null,
    printMeta: null,
    printWrap: null
  },

  /* =========================
     2. FUNCTIONS
  ========================= */
  cacheDom() {
    this.dom.overlay = document.getElementById("overlay");
    this.dom.overlayTitle = document.getElementById("overlayTitle");
    this.dom.overlayText = document.getElementById("overlayText");
    this.dom.closeBtn = document.getElementById("closeOverlay");
    this.dom.printBtn = document.getElementById("printBirthdaysBtn");
    this.dom.copyBtn = document.getElementById("copyBirthdaysBtn");
    this.dom.openSound = document.getElementById("openSound");
    this.dom.yearSelect = document.getElementById("yearSelect");
    this.dom.toggleOverviewBtn = document.getElementById("toggleOverviewBtn");
    this.dom.overviewGrid = document.getElementById("overviewGrid");
    this.dom.printMeta = document.getElementById("printMeta");
    this.dom.printWrap = document.getElementById("printWrap");

    // Ljud: undvik fel i file://
    if (this.dom.openSound) {
      const source = this.dom.openSound.querySelector("source");
      if (source) {
        if (location.protocol === "file:") {
          source.removeAttribute("src");
        } else {
          const ds = source.getAttribute("data-src");
          if (ds) source.setAttribute("src", ds);
        }
      }
      this.dom.openSound.load();
    }
  },

  calculateAge(birthYear) {
    const y = Number.isFinite(this.selectedYear) ? this.selectedYear : this.currentYear;
    return y - birthYear;
  },

  getIconForType(type, fallbackIcon = "") {
    const t = String(type || "").toLowerCase();
    const iconMap = {
      birthday: "üéÇ",
      event: "üóìÔ∏è",
      reminder: "‚è∞",
      holiday: "üéâ",
      note: "‚≠ê"
    };
    return iconMap[t] || fallbackIcon || "";
  },

  createDayItemButton(ev) {
    const btn = document.createElement("button");
    btn.className = "day-item";
    btn.type = "button";

    btn.dataset.day = String(ev.day);
    btn.dataset.month = String(ev.month);
    btn.dataset.type = String(ev.type);
    if (ev.year != null) btn.dataset.year = String(ev.year);
    if (ev.name != null) btn.dataset.name = String(ev.name);
    if (ev.text != null) btn.dataset.text = String(ev.text);

    const daySpan = document.createElement("span");
    daySpan.className = "day";
    daySpan.textContent = String(ev.day);

    const iconSpan = document.createElement("span");
    iconSpan.className = "icon";
    iconSpan.textContent = this.getIconForType(ev.type, ev.icon);

    const textSpan = document.createElement("span");
    textSpan.className = "text";
    textSpan.textContent = ev.name ? String(ev.name) : (ev.text ? String(ev.text) : "");

    const ageSpan = document.createElement("span");
    ageSpan.className = "age";
    ageSpan.textContent = "";

    btn.appendChild(daySpan);
    btn.appendChild(iconSpan);
    btn.appendChild(textSpan);
    btn.appendChild(ageSpan);

    return btn;
  },

  initYearSelect() {
    const yearSelect = this.dom.yearSelect;
    if (!yearSelect) return;

    const startYear = this.currentYear - 10;
    const endYear = this.currentYear + 10;

    yearSelect.innerHTML = "";

    for (let y = startYear; y <= endYear; y++) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSelect.appendChild(opt);
    }

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;

    yearSelect.addEventListener("change", () => {
      this.selectedYear = parseInt(yearSelect.value, 10);
      this.updateAllAges();

      if (document.body.classList.contains("overview-mode")) {
        this.buildOverview();
      }
    });

    yearSelect.addEventListener(
      "wheel",
      (event) => {
        event.preventDefault();
      },
      { passive: false }
    );
  },

  updateAllAges() {
    const buttons = document.querySelectorAll(this.selectors.birthdayButtons);

    buttons.forEach((btn) => {
      const birthYearRaw = btn.dataset.year;
      if (!birthYearRaw) return;

      const birthYear = parseInt(birthYearRaw, 10);
      if (Number.isNaN(birthYear)) return;

      const ageSpan = btn.querySelector(".age");
      if (!ageSpan) return;

      const age = this.calculateAge(birthYear);
      ageSpan.textContent = " " + age + " √•r";
    });
  },

  setOverviewButtonLabel() {
    const btn = this.dom.toggleOverviewBtn;
    if (!btn) return;

    const isOverview = document.body.classList.contains("overview-mode");
    btn.textContent = isOverview ? "Tillbaka till lista" : "Visa √∂versikt";
  },

  renderMonthsFromEvents() {
    const monthsRoot = document.getElementById("months");
    if (!monthsRoot) return;

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;
      byMonth.get(monthKey).push(ev);
    });

    const sections = Array.from(document.querySelectorAll(this.selectors.monthSections));

    sections.forEach((section) => {
      const monthKey = (section.dataset.month || "").toLowerCase().trim();
      const ul = section.querySelector("ul");
      if (!ul) return;

      ul.innerHTML = "";

      const monthEvents = byMonth.get(monthKey) || [];
      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      if (monthEvents.length === 0) {
        const li = document.createElement("li");
        li.dataset.type = "empty";

        const day = document.createElement("span");
        day.className = "day";
        day.textContent = "";

        const icon = document.createElement("span");
        icon.className = "icon";
        icon.textContent = "";

        const text = document.createElement("span");
        text.className = "text";
        text.textContent = "Inga h√§ndelser √§nnu";

        li.appendChild(day);
        li.appendChild(icon);
        li.appendChild(text);

        ul.appendChild(li);
        return;
      }

      monthEvents.forEach((ev) => {
        const li = document.createElement("li");
        const btn = this.createDayItemButton(ev);
        li.appendChild(btn);
        ul.appendChild(li);
      });
    });
  },

  buildOverview() {
    const overviewGrid = this.dom.overviewGrid;
    if (!overviewGrid) return;

    overviewGrid.innerHTML = "";

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;
      byMonth.get(monthKey).push(ev);
    });

    this.monthOrder.forEach((monthKey) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

      const monthDiv = document.createElement("div");
      monthDiv.className = "overview-month";

      const h2 = document.createElement("h2");
      h2.textContent = monthTitle;

      const ul = document.createElement("ul");

      monthEvents.forEach((ev) => {
        const li = document.createElement("li");
        const btn = this.createDayItemButton(ev);
        li.appendChild(btn);
        ul.appendChild(li);
      });

      if (ul.children.length === 0) return;

      monthDiv.appendChild(h2);
      monthDiv.appendChild(ul);
      overviewGrid.appendChild(monthDiv);
    });

    this.updateAllAges();
  },

  async copyBirthdaysToClipboard() {
    const text = this.buildBirthdaysText();

    if (location.protocol === "file:") {
      return false;
    }

    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        // fall through
      }
    }

    const ta = document.createElement("textarea");
    ta.value = text;

    ta.style.position = "fixed";
    ta.style.top = "0";
    ta.style.left = "0";
    ta.style.width = "1px";
    ta.style.height = "1px";
    ta.style.opacity = "0";

    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    let ok = false;
    try {
      ok = document.execCommand("copy");
    } catch (e) {
      ok = false;
    }

    document.body.removeChild(ta);
    return ok;
  },

  showCopyHelper(text) {
    const existing = document.getElementById("copyHelperOverlay");
    if (existing) existing.remove();

    const wrap = document.createElement("div");
    wrap.id = "copyHelperOverlay";
    wrap.style.position = "fixed";
    wrap.style.inset = "0";
    wrap.style.background = "rgba(0,0,0,0.5)";
    wrap.style.zIndex = "9999";
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    wrap.style.justifyContent = "center";
    wrap.style.padding = "16px";

    const box = document.createElement("div");
    box.style.background = "#fff";
    box.style.width = "min(720px, 100%)";
    box.style.maxHeight = "min(80vh, 100%)";
    box.style.borderRadius = "12px";
    box.style.padding = "12px";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "center";
    top.style.justifyContent = "space-between";
    top.style.gap = "12px";

    const title = document.createElement("div");
    title.textContent = "Kopiera listan";
    title.style.fontWeight = "600";

    const hint = document.createElement("div");
    hint.textContent = "Tryck Cmd+C (Mac) eller Ctrl+C (Windows) och st√§ng sedan.";
    hint.style.fontSize = "12px";
    hint.style.opacity = "0.8";

    const close = document.createElement("button");
    close.type = "button";
    close.textContent = "St√§ng";
    close.style.padding = "6px 10px";
    close.addEventListener("click", () => wrap.remove());

    const ta = document.createElement("textarea");
    ta.value = text;
    ta.readOnly = true;
    ta.style.width = "100%";
    ta.style.flex = "1";
    ta.style.minHeight = "240px";
    ta.style.resize = "vertical";

    top.appendChild(title);
    top.appendChild(close);

    box.appendChild(top);
    box.appendChild(hint);
    box.appendChild(ta);
    wrap.appendChild(box);
    document.body.appendChild(wrap);

    ta.focus();
    ta.select();
  },

  buildBirthdaysText() {
    const onlyBirthdays = true;

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      if (onlyBirthdays && String(ev.type).toLowerCase() !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    const lines = [];
    lines.push(`F√∂delsedagar ‚Äì √Ör ${this.selectedYear}`);
    lines.push("");

    this.monthOrder.forEach((monthKey) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);
      lines.push(monthTitle);

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        let ageText = "";
        if (ev.year != null) {
          const birthYear = parseInt(String(ev.year), 10);
          if (!Number.isNaN(birthYear)) {
            const age = this.calculateAge(birthYear);
            ageText = ` (${age} √•r)`;
          }
        }

        lines.push(`${day} üéÇ ${name}${ageText}`);
      });

      lines.push("");
    });

    return lines.join("\n").trim();
  },

  buildPrintView() {
    const { printMeta, printWrap } = this.dom;
    if (!printMeta || !printWrap) return;

    const onlyBirthdays = true;

    printMeta.textContent = `√Ör: ${this.selectedYear}`;
    printWrap.innerHTML = "";

    const colLeft = document.createElement("div");
    colLeft.className = "print-col print-col-left";

    const colRight = document.createElement("div");
    colRight.className = "print-col print-col-right";

    printWrap.appendChild(colLeft);
    printWrap.appendChild(colRight);

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      const evType = String(ev.type || "").toLowerCase();
      if (onlyBirthdays && evType !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    this.monthOrder.forEach((monthKey, idx) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

      const monthDiv = document.createElement("div");
      monthDiv.className = "print-month";

      const h2 = document.createElement("h2");
      h2.textContent = monthTitle;

      const ul = document.createElement("ul");

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        const evType = String(ev.type || "").trim().toLowerCase();
        const icon = evType === "birthday" ? "üéÇ" : "";

        let ageText = "";
        if (evType === "birthday" && ev.year != null) {
          const birthYear = parseInt(String(ev.year).trim(), 10);
          if (!Number.isNaN(birthYear)) {
            const age = this.calculateAge(birthYear);
            ageText = ` (${age} √•r)`;
          }
        }

        const li = document.createElement("li");
        li.textContent = `${day} ${icon} ${name}${ageText}`;
        ul.appendChild(li);
      });

      if (ul.children.length === 0) return;

      monthDiv.appendChild(h2);
      monthDiv.appendChild(ul);

      if (idx <= 5) {
        colLeft.appendChild(monthDiv);
      } else {
        colRight.appendChild(monthDiv);
      }
    });
  },

  printBirthdaysOnly() {
    this.handleBeforePrint();
    window.print();
  },

  resetPrintFlags() {
    document.body.classList.remove("print-birthdays-only");
    this._isPreparingPrint = false;
    this.resetYearToCurrent();
  },

  handleBeforePrint() {
    if (this._isPreparingPrint) return;
    this._isPreparingPrint = true;

    document.body.classList.add("print-birthdays-only");
    this.buildPrintView();
  },

  handleDocumentClick(event) {
    const dayButton = event.target.closest(".day-item");
    if (!dayButton) return;

    const hasDay = !!(dayButton.dataset && dayButton.dataset.day);
    const hasMonth = !!(dayButton.dataset && dayButton.dataset.month);
    if (!hasDay || !hasMonth) return;

    this.openOverlayFromButton(dayButton);
  },

  handleKeydown(event) {
    const { overlay } = this.dom;
    if (event.key === "Escape" && overlay) {
      this.closeOverlay();
    }
  },

  handleOverlayClick(event) {
    const { overlay } = this.dom;
    if (overlay && event.target === overlay) {
      this.closeOverlay();
    }
  },

  toggleOverview() {
    const willShow = !document.body.classList.contains("overview-mode");

    if (willShow) {
      document.body.classList.add("overview-mode");
      this.buildOverview();
    } else {
      document.body.classList.remove("overview-mode");
      this.resetYearToCurrent();
    }

    this.setOverviewButtonLabel();
  },

  resetYearToCurrent() {
    const { yearSelect } = this.dom;
    if (!yearSelect) return;

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;
    this.updateAllAges();

    if (document.body.classList.contains("overview-mode")) {
      this.buildOverview();
    }
  },

  openOverlayFromButton(dayButton) {
    const { overlay, overlayTitle, overlayText, openSound } = this.dom;
    if (!overlay || !overlayTitle || !overlayText) return;

    const monthKey = (dayButton.dataset.month || "").trim().toLowerCase();
    const month = monthKey ? monthKey.charAt(0).toUpperCase() + monthKey.slice(1) : "";

    const day = (dayButton.dataset.day || "").trim();
    const type = (dayButton.dataset.type || "").trim().toLowerCase();
    const birthYearRaw = dayButton.dataset.year;
    const name = (dayButton.dataset.name || "").trim();
    const text = (dayButton.dataset.text || "").trim();

    overlayTitle.textContent = day && month ? `${day} ${month}` : (month || "");

    if (type === "birthday" && birthYearRaw && name) {
      const birthYear = parseInt(birthYearRaw, 10);
      if (!Number.isNaN(birthYear)) {
        const age = this.calculateAge(birthYear);
        overlayText.textContent = `${name} fyller ${age} √•r`;
      } else {
        overlayText.textContent = name;
      }
    } else {
      overlayText.textContent = text || name || "";
    }

    overlay.classList.remove("hidden");

    if (openSound) {
      const p = openSound.play();
      if (p && typeof p.catch === "function") {
        p.catch(() => {});
      }
    }
  },

  closeOverlay() {
    const { overlay } = this.dom;
    if (!overlay) return;
    overlay.classList.add("hidden");

    if (!document.body.classList.contains("overview-mode") && this.selectedYear !== this.currentYear) {
      this.resetYearToCurrent();
    }
  },

  bindEvents() {
    const { toggleOverviewBtn, closeBtn, overlay, printBtn, copyBtn } = this.dom;

    if (toggleOverviewBtn) {
      toggleOverviewBtn.addEventListener("click", () => {
        this.toggleOverview();
      });
    }

    document.addEventListener("click", (event) => {
      this.handleDocumentClick(event);
    });

    if (closeBtn && overlay) {
      closeBtn.addEventListener("click", () => {
        this.closeOverlay();
      });
    }

    if (overlay) {
      overlay.addEventListener("click", (event) => {
        this.handleOverlayClick(event);
      });
    }

    document.addEventListener("keydown", (event) => {
      this.handleKeydown(event);
    });

    window.addEventListener("beforeprint", () => {
      this.handleBeforePrint();
    });

    window.addEventListener("afterprint", () => {
      this.resetPrintFlags();
    });

    if (printBtn) {
      printBtn.addEventListener("click", () => {
        this.printBirthdaysOnly();
      });
    }

    if (copyBtn) {
      copyBtn.addEventListener("click", async () => {
        const text = this.buildBirthdaysText();
        const ok = await this.copyBirthdaysToClipboard();

        if (!ok) {
          this.showCopyHelper(text);
        }
      });
    }
  },

  init() {
    this.selectedYear = this.currentYear;
    this.cacheDom();

    this.renderMonthsFromEvents();

    this.bindEvents();
    this.initYearSelect();
    this.updateAllAges();
    this.setOverviewButtonLabel();
  }
};

window.addEventListener("load", () => {
  App.init();
});
</script>

<audio id="openSound" preload="none">
  <source data-src="./pop.mp3" type="audio/mpeg">
</audio>

</body>
</html>
