<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>√Örshjul</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    line-height: 1.5;
    margin: 2rem;
  }

  h1 {
    margin-bottom: 1.25rem;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1.25rem;
  }

  .controls button,
  .controls select {
    font: inherit;
  }
/* N√§r overlay √§r √∂ppen: inga klick p√• toppkontroller */
body.controls-locked .controls {
  pointer-events: none;
}

body.controls-locked .controls button,
body.controls-locked .controls select,
body.controls-locked .controls label {
  opacity: 0.5;
}

  /* Months list */
  section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ddd;
  }

  h2 {
    margin-bottom: 0.5rem;
  }

  ul {
    margin: 0;
    padding-left: 1.2rem;
  }

  li {
    margin-bottom: 0.3rem;
  }

  .day-item {
    all: unset;
    display: grid;
    grid-template-columns: 2.5em 1.8em auto;
    align-items: center;
    width: 100%;
    cursor: pointer;
  }

  .day {
    min-width: 2em;
    display: inline-block;
  }

  .icon {
    width: 1.8em;
    text-align: center;
  }

/* Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20000;
  }

  .overlay-content {
    position: relative;
    z-index: 20001;
  }

.overlay-content {
  background: white;
  padding: 1.5rem;
  max-width: 420px;
  width: 90%;
  border-radius: 8px;
}

.hidden {
  display: none;
}

/* Event form (Steg 1) */
.event-form {
  display: grid;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.event-field {
  display: grid;
  gap: 0.25rem;
}

.event-field label {
  font-weight: 600;
  font-size: 0.95rem;
}

.event-field input,
.event-field select,
.event-field textarea {
  font: inherit;
  padding: 0.5rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.event-field textarea {
  resize: vertical;
}

.event-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 0.25rem;
}

.event-actions button {
  font: inherit;
  padding: 0.5rem 0.75rem;
}

  /* ===== OVERVIEW MODE (aktiveras senare med JS) ===== */
  #overview {
    display: none;
    margin-top: 1rem;
  }

  body.overview-mode #months {
    display: none;
  }

  body.overview-mode #overview {
    display: block;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (max-width: 900px) {
    .overview-grid {
      grid-template-columns: 1fr;
    }
  }

  .overview-month {
    border: 1px solid #eee;
    padding: 0.75rem;
    border-radius: 8px;
  }

  .overview-month h2 {
    margin: 0 0 0.4rem 0;
    font-size: 1.1rem;
  }

  .overview-month ul {
    padding-left: 1.1rem;
  }

  .overview-month li {
    margin-bottom: 0.2rem;
  }

  /* D√∂lj √•lder i normal vy */
  .age {
    display: none !important;
  }

/* D√∂lj print-vyn i normalvy */
#printMeta,
#printWrap {
  display: none;
}

/* ===== PRINT ===== */
@media print {

  /* D√∂lj kontroller + overlay + originalvyn (vi skriver ut print-wrappern i st√§llet) */
  .controls,
  #overview,
  #overlay,
  #months {
    display: none !important;
  }

  /* Visa print-wrappern */
  #printMeta {
    display: block !important;
  }

  #printWrap {
    display: flex !important;
  }

  /* Bas f√∂r sidan (st√∂rre text, men h√•ll 1 sida) */
  body {
    font-size: 12.5pt !important;
    line-height: 1.25 !important;
    margin: 10mm !important;
  }

  h1 {
    font-size: 18pt !important;
    margin: 0 0 2mm 0 !important;
  }

  /* Tydlig rad med valt √•r */
  #printMeta {
    font-size: 12.5pt !important;
    margin: 0 0 6mm 0 !important;
  }

  /* Tv√• kolumner */
  #printWrap {
    gap: 14mm;
    align-items: flex-start;
  }

  .print-col {
    flex: 1 1 0;
    min-width: 0;
  }

  /* M√•nadskort i print */
  .print-month {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  .print-month h2 {
    margin: 0 0 2.5mm 0 !important;
    font-size: 14pt !important;
  }

  .print-month ul {
    margin: 0 !important;
    padding-left: 0 !important;
    list-style: none !important;
  }

  .print-month li {
    margin: 0 0 1.75mm 0 !important;
  }

  hr {
    display: none !important;
  }
}
/* Tydlig visuell indikator n√§r toppkontroller √§r l√•sta */
body.controls-locked .controls {
  opacity: 0.55;
  pointer-events: none;
}

body.controls-locked #copyHelperOverlay {
  pointer-events: auto;
  opacity: 1;
}

</style>
  
</head>
<body>

<h1>√Örshjul</h1>

<div class="controls">
  <button id="printBirthdaysBtn" type="button">
    Skriv ut ‚Äì endast f√∂delsedagar
  </button>
  <button id="copyBirthdaysBtn" type="button">Kopiera f√∂delsedagslista</button>

  <button id="addEventBtn" type="button">L√§gg till h√§ndelse</button>

  <button id="exportEventsBtn" type="button">Exportera h√§ndelser</button>
  <button id="importEventsBtn" type="button">Importera h√§ndelser</button>

  <button id="toggleOverviewBtn" type="button">
    Visa √∂versikt
  </button>

  <label class="year-control" for="yearSelect">√Ör:</label>
  <select id="yearSelect" class="year-control" aria-label="V√§lj √•r"></select>
</div>

<!-- Print-only (byggs av JS precis innan utskrift) -->
<div id="printMeta" class="print-only"></div>
<div id="printWrap" class="print-only"></div>

<main id="months">

<section data-month="januari">

  <h2>Januari</h2>
  <ul>

  <li>
  <button
    class="day-item"
    data-day="3"
    data-month="januari"
    data-type="birthday"
    data-year="1947"
    data-name="Lars"
    type="button"
  >
    <span class="day">3</span>
    <span class="icon">üéÇ</span>
    <span class="text">Lars</span>
<span class="age"></span>
  </button>
</li>
 
  </ul>
</section>

<section data-month="februari">
  <h2>Februari</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="6"
        data-month="februari"
        data-type="birthday"
        data-year="2009"
        data-name="Sophie"
        type="button"
      >
        <span class="day">6</span>
        <span class="icon">üéÇ</span>
        <span class="text">Sophie</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

  <section data-month="mars">
  <h2>Mars</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="10"
        data-month="mars"
        data-type="birthday"
        data-year="2006"
        data-name="Theodor"
        type="button"
      >
        <span class="day">10</span>
        <span class="icon">üéÇ</span>
        <span class="text">Theodor</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="12"
        data-month="mars"
        data-type="birthday"
        data-year="2013"
        data-name="Milton"
        type="button"
      >
        <span class="day">12</span>
        <span class="icon">üéÇ</span>
        <span class="text">Milton</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="15"
        data-month="mars"
        data-type="birthday"
        data-year="1986"
        data-name="Linda"
        type="button"
      >
        <span class="day">15</span>
        <span class="icon">üéÇ</span>
        <span class="text">Linda</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="16"
        data-month="mars"
        data-type="birthday"
        data-year="1989"
        data-name="Mathilda"
        type="button"
      >
        <span class="day">16</span>
        <span class="icon">üéÇ</span>
        <span class="text">Mathilda</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="17"
        data-month="mars"
        data-type="birthday"
        data-year="1976"
        data-name="David"
        type="button"
      >
        <span class="day">17</span>
        <span class="icon">üéÇ</span>
        <span class="text">David</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="april">
  <h2>April</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="maj">
  <h2>Maj</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="14"
        data-month="maj"
        data-type="birthday"
        data-year="2013"
        data-name="Myra"
        type="button"
      >
        <span class="day">14</span>
        <span class="icon">üéÇ</span>
        <span class="text">Myra</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="18"
        data-month="maj"
        data-type="birthday"
        data-year="1981"
        data-name="Emanuel"
        type="button"
      >
        <span class="day">18</span>
        <span class="icon">üéÇ</span>
        <span class="text">Emanuel</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="juni">
  <h2>Juni</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="juli">
  <h2>Juli</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="30"
        data-month="juli"
        data-type="birthday"
        data-year="2025"
        data-name="Isabelle"
        type="button"
      >
        <span class="day">30</span>
        <span class="icon">üéÇ</span>
        <span class="text">Isabelle</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="augusti">
  <h2>Augusti</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="3"
        data-month="augusti"
        data-type="birthday"
        data-year="2007"
        data-name="Leo"
        type="button"
      >
        <span class="day">3</span>
        <span class="icon">üéÇ</span>
        <span class="text">Leo</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="7"
        data-month="augusti"
        data-type="birthday"
        data-year="1987"
        data-name="Martin"
        type="button"
      >
        <span class="day">7</span>
        <span class="icon">üéÇ</span>
        <span class="text">Martin</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="30"
        data-month="augusti"
        data-type="birthday"
        data-year="2007"
        data-name="Tristan"
        type="button"
      >
        <span class="day">30</span>
        <span class="icon">üéÇ</span>
        <span class="text">Tristan</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="september">
  <h2>September</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="1"
        data-month="september"
        data-type="birthday"
        data-year="2005"
        data-name="Max"
        type="button"
      >
        <span class="day">1</span>
        <span class="icon">üéÇ</span>
        <span class="text">Max</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="4"
        data-month="september"
        data-type="birthday"
        data-year="1982"
        data-name="Charlotte"
        type="button"
      >
        <span class="day">4</span>
        <span class="icon">üéÇ</span>
        <span class="text">Charlotte</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="25"
        data-month="september"
        data-type="birthday"
        data-year="1978"
        data-name="Victor"
        type="button"
      >
        <span class="day">25</span>
        <span class="icon">üéÇ</span>
        <span class="text">Victor</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="oktober">
  <h2>Oktober</h2>
  <ul>
    <li data-type="empty">
      <span class="day"></span>
      <span class="icon"></span>
      <span class="text">Inga h√§ndelser √§nnu</span>
    </li>
  </ul>
</section>

<section data-month="november">
  <h2>November</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="6"
        data-month="november"
        data-type="birthday"
        data-year="1971"
        data-name="Nina"
        type="button"
      >
        <span class="day">6</span>
        <span class="icon">üéÇ</span>
        <span class="text">Nina</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="14"
        data-month="november"
        data-type="birthday"
        data-year="1968"
        data-name="Jennie"
        type="button"
      >
        <span class="day">14</span>
        <span class="icon">üéÇ</span>
        <span class="text">Jennie</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="29"
        data-month="november"
        data-type="birthday"
        data-year="1973"
        data-name="Calle"
        type="button"
      >
        <span class="day">29</span>
        <span class="icon">üéÇ</span>
        <span class="text">Calle</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

<section data-month="december">
  <h2>December</h2>
  <ul>

    <li>
      <button
        class="day-item"
        data-day="5"
        data-month="december"
        data-type="birthday"
        data-year="2019"
        data-name="Mila"
        type="button"
      >
        <span class="day">5</span>
        <span class="icon">üéÇ</span>
        <span class="text">Mila</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="9"
        data-month="december"
        data-type="birthday"
        data-year="1949"
        data-name="Ann"
        type="button"
      >
        <span class="day">9</span>
        <span class="icon">üéÇ</span>
        <span class="text">Ann</span>
<span class="age"></span>
      </button>
    </li>

    <li>
      <button
        class="day-item"
        data-day="20"
        data-month="december"
        data-type="birthday"
        data-year="1978"
        data-name="Frida"
        type="button"
      >
        <span class="day">20</span>
        <span class="icon">üéÇ</span>
        <span class="text">Frida</span>
<span class="age"></span>
      </button>
    </li>

  </ul>
</section>

</main>

<!-- Overview (visas n√§r body har klassen overview-mode) -->
<div id="overview">
  <div class="overview-grid" id="overviewGrid"></div>
</div>

<div id="overlay" class="overlay hidden">

  <div class="overlay-content">
    <button id="closeOverlay">St√§ng √ó</button>
    <h2 id="overlayTitle">Februari</h2>
    <p id="overlayText">H√§r ska informationen om februari visas.</p>
  </div>
</div>

<script>
const App = {
  /* =========================
     0. STATE
  ========================= */
  currentYear: new Date().getFullYear(),
  selectedYear: null,
  _isPreparingPrint: false,

    monthOrder: [
    "januari",
    "februari",
    "mars",
    "april",
    "maj",
    "juni",
    "juli",
    "augusti",
    "september",
    "oktober",
    "november",
    "december"
  ],

  // Anv√§nds n√§r vi mappar YYYY-MM-DD -> m√•nad i text
  monthNames: [
    "januari",
    "februari",
    "mars",
    "april",
    "maj",
    "juni",
    "juli",
    "augusti",
    "september",
    "oktober",
    "november",
    "december"
  ],

  selectors: {
    monthSections: "#months > section",
    birthdayButtons: '.day-item[data-type="birthday"]'
  },

  // FAS 4: datak√§lla
  events: [
  // DEMO-data (publik version). L√§gg din privata familjedata lokalt, inte i repo.
  { type: "birthday", day: 3, month: "januari", year: 1990, name: "Person A" },
  { type: "birthday", day: 6, month: "februari", year: 2000, name: "Person B" },

  { type: "birthday", day: 10, month: "mars", year: 1985, name: "Person C" },
  { type: "birthday", day: 12, month: "mars", year: 2010, name: "Person D" },

  { type: "birthday", day: 14, month: "maj", year: 1995, name: "Person E" },
  { type: "birthday", day: 18, month: "maj", year: 1988, name: "Person F" },

  { type: "birthday", day: 30, month: "juli", year: 2021, name: "Person G" },

  { type: "birthday", day: 3, month: "augusti", year: 2007, name: "Person H" },
  { type: "birthday", day: 7, month: "augusti", year: 1987, name: "Person I" },

  { type: "birthday", day: 1, month: "september", year: 2005, name: "Person J" },
  { type: "birthday", day: 4, month: "september", year: 1982, name: "Person K" },

  { type: "birthday", day: 6, month: "november", year: 1971, name: "Person L" },
  { type: "birthday", day: 14, month: "november", year: 1992, name: "Person M" },

  { type: "birthday", day: 5, month: "december", year: 2019, name: "Person N" },
  { type: "birthday", day: 9, month: "december", year: 1949, name: "Person O" }
],
  /* =========================
     1. DOM REFERENCES
  ========================= */
  dom: {
    overlay: null,
    overlayTitle: null,
    overlayText: null,
    closeBtn: null,

    printBtn: null,
    copyBtn: null,
    addEventBtn: null,

    exportEventsBtn: null,
    importEventsBtn: null,

    openSound: null,
    yearSelect: null,
    toggleOverviewBtn: null,
    overviewGrid: null,
    printMeta: null,
    printWrap: null
  },

  /* ==========================
     2. FUNCTIONS
  ========================= */
cacheDom() {
  this.dom.overlay = document.getElementById("overlay");
  this.dom.overlayTitle = document.getElementById("overlayTitle");
  this.dom.overlayText = document.getElementById("overlayText");
  this.dom.closeBtn = document.getElementById("closeOverlay");
  this.dom.printBtn = document.getElementById("printBirthdaysBtn");
  this.dom.copyBtn = document.getElementById("copyBirthdaysBtn");
  this.dom.addEventBtn = document.getElementById("addEventBtn");

  this.dom.exportEventsBtn = document.getElementById("exportEventsBtn");
  this.dom.importEventsBtn = document.getElementById("importEventsBtn");

  this.dom.openSound = document.getElementById("openSound");
  this.dom.yearSelect = document.getElementById("yearSelect");
  this.dom.toggleOverviewBtn = document.getElementById("toggleOverviewBtn");
  this.dom.overviewGrid = document.getElementById("overviewGrid");
  this.dom.printMeta = document.getElementById("printMeta");
  this.dom.printWrap = document.getElementById("printWrap");

  // Ljud: undvik fel i file://
  if (this.dom.openSound) {
    const source = this.dom.openSound.querySelector("source");
    if (source) {
      if (location.protocol === "file:") {
        source.removeAttribute("src");
      } else {
        const ds = source.getAttribute("data-src");
        if (ds) source.setAttribute("src", ds);
      }
    }
    this.dom.openSound.load();
  }
},

    lockTopControls() {
  document.body.classList.add("controls-locked");
  if (this.dom.yearSelect) this.dom.yearSelect.disabled = true;
  if (this.dom.printBtn) this.dom.printBtn.disabled = true;
  if (this.dom.copyBtn) this.dom.copyBtn.disabled = true;
  if (this.dom.toggleOverviewBtn) this.dom.toggleOverviewBtn.disabled = true;
  if (this.dom.addEventBtn) this.dom.addEventBtn.disabled = true;

  if (this.dom.exportEventsBtn) this.dom.exportEventsBtn.disabled = true;
  if (this.dom.importEventsBtn) this.dom.importEventsBtn.disabled = true;
},

 unlockTopControls() {
  document.body.classList.remove("controls-locked");
  if (this.dom.yearSelect) this.dom.yearSelect.disabled = false;
  if (this.dom.printBtn) this.dom.printBtn.disabled = false;
  if (this.dom.copyBtn) this.dom.copyBtn.disabled = false;
  if (this.dom.toggleOverviewBtn) this.dom.toggleOverviewBtn.disabled = false;
  if (this.dom.addEventBtn) this.dom.addEventBtn.disabled = false;

  if (this.dom.exportEventsBtn) this.dom.exportEventsBtn.disabled = false;
  if (this.dom.importEventsBtn) this.dom.importEventsBtn.disabled = false;
},

  calculateAge(birthYear) {
    const y = Number.isFinite(this.selectedYear) ? this.selectedYear : this.currentYear;
    return y - birthYear;
  },

  getIconForType(type, fallbackIcon = "") {
  const fb = String(fallbackIcon || "").trim();
  if (fb) return fb; // <-- anv√§ndarens val ska vinna

  const t = String(type || "").toLowerCase();
  const iconMap = {
    birthday: "üéÇ",
    event: "üóìÔ∏è",
    reminder: "‚è∞",
    holiday: "üéâ",
    note: "‚≠ê"
  };
  return iconMap[t] || "";
},

  createDayItemButton(ev) {
  const btn = document.createElement("button");
  btn.className = "day-item";
  btn.type = "button";

  btn.dataset.day = String(ev.day);
  btn.dataset.month = String(ev.month);
  btn.dataset.type = String(ev.type);

  if (ev.id != null) btn.dataset.id = String(ev.id);
  if (ev.year != null) btn.dataset.year = String(ev.year);
  if (ev.name != null) btn.dataset.name = String(ev.name);
  if (ev.text != null) btn.dataset.text = String(ev.text);
  if (ev.icon != null) btn.dataset.icon = String(ev.icon);

  const daySpan = document.createElement("span");
  daySpan.className = "day";
  daySpan.textContent = String(ev.day);

  const iconSpan = document.createElement("span");
  iconSpan.className = "icon";
  iconSpan.textContent = this.getIconForType(ev.type, ev.icon);

  const textSpan = document.createElement("span");
  textSpan.className = "text";
  textSpan.textContent = ev.name ? String(ev.name) : (ev.text ? String(ev.text) : "");

  const ageSpan = document.createElement("span");
  ageSpan.className = "age";
  ageSpan.textContent = "";

  btn.appendChild(daySpan);
  btn.appendChild(iconSpan);
  btn.appendChild(textSpan);
  btn.appendChild(ageSpan);

  return btn;
},

  initYearSelect() {
    const yearSelect = this.dom.yearSelect;
    if (!yearSelect) return;

    const startYear = this.currentYear - 10;
    const endYear = this.currentYear + 10;

    yearSelect.innerHTML = "";

    for (let y = startYear; y <= endYear; y++) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSelect.appendChild(opt);
    }

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;

    yearSelect.addEventListener("change", () => {
      this.selectedYear = parseInt(yearSelect.value, 10);
      this.updateAllAges();

      if (document.body.classList.contains("overview-mode")) {
        this.buildOverview();
      }
    });

    yearSelect.addEventListener(
      "wheel",
      (event) => {
        event.preventDefault();
      },
      { passive: false }
    );
  },

  updateAllAges() {
    const buttons = document.querySelectorAll(this.selectors.birthdayButtons);

    buttons.forEach((btn) => {
      const birthYearRaw = btn.dataset.year;
      if (!birthYearRaw) return;

      const birthYear = parseInt(birthYearRaw, 10);
      if (Number.isNaN(birthYear)) return;

      const ageSpan = btn.querySelector(".age");
      if (!ageSpan) return;

      const age = this.calculateAge(birthYear);
      ageSpan.textContent = " " + age + " √•r";
    });
  },

  setOverviewButtonLabel() {
    const btn = this.dom.toggleOverviewBtn;
    if (!btn) return;

    const isOverview = document.body.classList.contains("overview-mode");
    btn.textContent = isOverview ? "Tillbaka till lista" : "Visa √∂versikt";
  },

  renderMonthsFromEvents() {
  const monthsRoot = document.getElementById("months");
  if (!monthsRoot) return;

  const byMonth = new Map();
  this.monthOrder.forEach((m) => byMonth.set(m, []));

  // 1) Bas: befintliga events (t.ex. birthdays)
  const baseEvents = Array.isArray(this.events) ? this.events : [];

  // 2) User events fr√•n localStorage -> mappa date -> month/day
  const userRaw = this.getUserEvents();
  const userEvents = userRaw
    .map((ev) => {
      if (!ev || !ev.date) return null;

      const parts = String(ev.date).split("-");
      if (parts.length !== 3) return null;

      const y = Number(parts[0]);
      const m = Number(parts[1]); // 1-12
      const d = Number(parts[2]); // 1-31
      if (!y || !m || !d) return null;

      const monthName = this.monthNames?.[m - 1]; // "januari" osv
      if (!monthName) return null;

     return {
  ...ev,
  type: "event",
  icon: ev.icon || "üóìÔ∏è",   // <-- L√ÑGG TILL
  year: y,
  month: monthName,
  day: d,
  name: ev.title || "H√§ndelse",
  text:
    (ev.time ? `${ev.time} ` : "") +
    (ev.place ? `${ev.place} ` : "") +
    (ev.desc ? `${ev.desc}` : ""),
  createdBy: ev.createdBy || ""
};
    })
    .filter(Boolean);

  const allEvents = [...baseEvents, ...userEvents];

  // L√§gg in i byMonth
  allEvents.forEach((ev) => {
    if (!ev || !ev.month) return;
    const monthKey = String(ev.month).toLowerCase().trim();
    if (!byMonth.has(monthKey)) return;
    byMonth.get(monthKey).push(ev);
  });

  const sections = Array.from(document.querySelectorAll(this.selectors.monthSections));

  sections.forEach((section) => {
    const monthKey = (section.dataset.month || "").toLowerCase().trim();
    const ul = section.querySelector("ul");
    if (!ul) return;

    ul.innerHTML = "";

    const monthEvents = byMonth.get(monthKey) || [];

    // Sort: day, och om samma dag: birthday f√∂re event
    monthEvents.sort((a, b) => {
      const da = a.day || 0;
      const db = b.day || 0;
      if (da !== db) return da - db;

      const pa = a.type === "birthday" ? 0 : 1;
      const pb = b.type === "birthday" ? 0 : 1;
      return pa - pb;
    });

    if (monthEvents.length === 0) {
      const li = document.createElement("li");
      li.dataset.type = "empty";

      const day = document.createElement("span");
      day.className = "day";
      day.textContent = "";

      const icon = document.createElement("span");
      icon.className = "icon";
      icon.textContent = "";

      const text = document.createElement("span");
      text.className = "text";
      text.textContent = "Inga h√§ndelser √§nnu";

      li.appendChild(day);
      li.appendChild(icon);
      li.appendChild(text);

      ul.appendChild(li);
      return;
    }

    monthEvents.forEach((ev) => {
      const li = document.createElement("li");
      const btn = this.createDayItemButton(ev);
      li.appendChild(btn);
      ul.appendChild(li);
    });
  });
},

  buildOverview() {
    const overviewGrid = this.dom.overviewGrid;
    if (!overviewGrid) return;

    overviewGrid.innerHTML = "";

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;
      byMonth.get(monthKey).push(ev);
    });

    this.monthOrder.forEach((monthKey) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

      const monthDiv = document.createElement("div");
      monthDiv.className = "overview-month";

      const h2 = document.createElement("h2");
      h2.textContent = monthTitle;

      const ul = document.createElement("ul");

      monthEvents.forEach((ev) => {
        const li = document.createElement("li");
        const btn = this.createDayItemButton(ev);
        li.appendChild(btn);
        ul.appendChild(li);
      });

      if (ul.children.length === 0) return;

      monthDiv.appendChild(h2);
      monthDiv.appendChild(ul);
      overviewGrid.appendChild(monthDiv);
    });

    this.updateAllAges();
  },

  async copyBirthdaysToClipboard() {
    const text = this.buildBirthdaysText();

    if (location.protocol === "file:") {
      return false;
    }

    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        // fall through
      }
    }

    const ta = document.createElement("textarea");
    ta.value = text;

    ta.style.position = "fixed";
    ta.style.top = "0";
    ta.style.left = "0";
    ta.style.width = "1px";
    ta.style.height = "1px";
    ta.style.opacity = "0";

    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    let ok = false;
    try {
      ok = document.execCommand("copy");
    } catch (e) {
      ok = false;
    }

    document.body.removeChild(ta);
    return ok;
  },

    showCopyHelper(text) {
    const existing = document.getElementById("copyHelperOverlay");
    if (existing) existing.remove();

        // L√•s toppkontroller medan kopieramodalen √§r √∂ppen
    this.lockTopControls();

    const wrap = document.createElement("div");
    wrap.id = "copyHelperOverlay";
    wrap.style.position = "fixed";
    wrap.style.inset = "0";
    wrap.style.background = "rgba(0,0,0,0.5)";
    wrap.style.zIndex = "9999";
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    wrap.style.justifyContent = "center";
    wrap.style.padding = "16px";

    const box = document.createElement("div");
    box.style.background = "#fff";
    box.style.width = "min(720px, 100%)";
    box.style.maxHeight = "min(80vh, 100%)";
    box.style.borderRadius = "12px";
    box.style.padding = "12px";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "center";
    top.style.justifyContent = "space-between";
    top.style.gap = "12px";

    const title = document.createElement("div");
    title.textContent = "Kopiera listan";
    title.style.fontWeight = "600";

    const hint = document.createElement("div");
    hint.textContent = "Tryck Cmd+C (Mac) eller Ctrl+C (Windows) och st√§ng sedan.";
    hint.style.fontSize = "12px";
    hint.style.opacity = "0.8";

    const close = document.createElement("button");
    close.type = "button";
    close.textContent = "St√§ng";
    close.style.padding = "6px 10px";

    const ta = document.createElement("textarea");
    ta.value = text;
    ta.readOnly = true;
    ta.style.width = "100%";
    ta.style.flex = "1";
    ta.style.minHeight = "240px";
    ta.style.resize = "vertical";

    // Stabil kolumnk√§nsla i modalen
    ta.style.fontFamily =
      'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ta.style.fontVariantNumeric = "tabular-nums";

        const unlockControls = () => {
      this.unlockTopControls();
    };

    const closeModal = () => {
      wrap.remove();
      unlockControls();

      // N√§r man st√§nger kopieringsf√∂nstret: √•terg√• till nuvarande √•r i linj√§ra vyn
      if (!document.body.classList.contains("overview-mode") && this.selectedYear !== this.currentYear) {
        this.resetYearToCurrent();
      }

      // S√§tt tillbaka fokus s√• UI k√§nns ‚Äúklart‚Äù
      if (this.dom.copyBtn) this.dom.copyBtn.focus();
    };

    close.addEventListener("click", closeModal);

    // Klick p√• bakgrunden st√§nger (valfritt men stabilt)
    wrap.addEventListener("click", (e) => {
      if (e.target === wrap) closeModal();
    });

    top.appendChild(title);
    top.appendChild(close);

    box.appendChild(top);
    box.appendChild(hint);
    box.appendChild(ta);
    wrap.appendChild(box);
    document.body.appendChild(wrap);

    ta.focus();
    ta.select();
  },

  buildBirthdaysText() {
    const onlyBirthdays = true;

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      if (onlyBirthdays && String(ev.type).toLowerCase() !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    const lines = [];
    lines.push(`F√∂delsedagar ‚Äì √Ör ${this.selectedYear}`);
    lines.push("");

    this.monthOrder.forEach((monthKey) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);
      lines.push(monthTitle);

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        let ageText = "";
        if (ev.year != null) {
          const birthYear = parseInt(String(ev.year), 10);
          if (!Number.isNaN(birthYear)) {
            const age = this.calculateAge(birthYear);
            ageText = ` (${age} √•r)`;
          }
        }

               const paddedDay = day.padStart(2, " ");
 
        lines.push(`${paddedDay}\tüéÇ\t${name}${ageText}`);
      });

      lines.push("");
    });

    return lines.join("\n").trim();
  },

  buildPrintView() {
    const { printMeta, printWrap } = this.dom;
    if (!printMeta || !printWrap) return;

    const onlyBirthdays = true;

    printMeta.textContent = `√Ör: ${this.selectedYear}`;
    printWrap.innerHTML = "";
    // Print: styles f√∂r fasta kolumner (endast f√∂r printlistan)
    if (!document.getElementById("printBirthdayRowStyles")) {
      const style = document.createElement("style");
      style.id = "printBirthdayRowStyles";
      style.textContent = `
        .print-row {
          display: grid;
          grid-template-columns: 2ch 2ch 1fr;
          column-gap: 0.6ch;
          align-items: baseline;
        }
        .print-row .print-day {
          text-align: right;
          font-variant-numeric: tabular-nums;
        }
        .print-row .print-icon {
          text-align: center;
        }
      `;
      document.head.appendChild(style);
    }

    const colLeft = document.createElement("div");
    colLeft.className = "print-col print-col-left";

    const colRight = document.createElement("div");
    colRight.className = "print-col print-col-right";

    printWrap.appendChild(colLeft);
    printWrap.appendChild(colRight);

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.events.forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      const evType = String(ev.type || "").toLowerCase();
      if (onlyBirthdays && evType !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    this.monthOrder.forEach((monthKey, idx) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

      const monthDiv = document.createElement("div");
      monthDiv.className = "print-month";

      const h2 = document.createElement("h2");
      h2.textContent = monthTitle;

      const ul = document.createElement("ul");

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        const evType = String(ev.type || "").trim().toLowerCase();
        const icon = evType === "birthday" ? "üéÇ" : "";

        let ageText = "";
        if (evType === "birthday" && ev.year != null) {
          const birthYear = parseInt(String(ev.year).trim(), 10);
          if (!Number.isNaN(birthYear)) {
            const age = this.calculateAge(birthYear);
            ageText = ` (${age} √•r)`;
          }
        }

         const li = document.createElement("li");
        li.className = "print-row";

        const daySpan = document.createElement("span");
        daySpan.className = "print-day";
        daySpan.textContent = day;

        const iconSpan = document.createElement("span");
        iconSpan.className = "print-icon";
        iconSpan.textContent = icon;

        const textSpan = document.createElement("span");
        textSpan.className = "print-text";
        textSpan.textContent = `${name}${ageText}`;

        li.appendChild(daySpan);
        li.appendChild(iconSpan);
        li.appendChild(textSpan);

        ul.appendChild(li);

      });

      if (ul.children.length === 0) return;

      monthDiv.appendChild(h2);
      monthDiv.appendChild(ul);

      if (idx <= 5) {
        colLeft.appendChild(monthDiv);
      } else {
        colRight.appendChild(monthDiv);
      }
    });
  },

  printBirthdaysOnly() {
  // Sp√§rra print n√§r overlay √§r √∂ppen
  if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;

  this.handleBeforePrint();
  window.print();
},
      resetPrintFlags() {
    document.body.classList.remove("print-birthdays-only");
    this._isPreparingPrint = false;

    if (this.dom.printWrap) this.dom.printWrap.innerHTML = "";

       // L√•s upp toppkontroller igen
    this.unlockTopControls();

    // Efter print: √•terg√• till nuvarande √•r (2026)
    this.resetYearToCurrent();
  },
 
    handleBeforePrint() {
    if (this._isPreparingPrint) return;
    this._isPreparingPrint = true;

        // L√•s toppkontroller under print (f√∂ruts√§gbart l√§ge)
    this.lockTopControls();

    // St√§ng overlay visuellt inf√∂r print
    if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) {
      this.dom.overlay.classList.add("hidden");
    }

    document.body.classList.add("print-birthdays-only");
    this.buildPrintView();
  },

  handleDocumentClick(event) {
   
    const dayButton = event.target.closest(".day-item");
    if (!dayButton) return;

    const hasDay = !!(dayButton.dataset && dayButton.dataset.day);
    const hasMonth = !!(dayButton.dataset && dayButton.dataset.month);
    if (!hasDay || !hasMonth) return;

    this.openOverlayFromButton(dayButton);
  },

  handleKeydown(event) {
    const { overlay } = this.dom;
    if (event.key === "Escape" && overlay) {
      this.closeOverlay();
    }
  },

 handleOverlayClick(event) {
  const { overlay } = this.dom;
  if (!overlay) return;

  // Klick p√• sj√§lva bakgrunden (inte inne i rutan)
  if (event.target === overlay) {
    event.preventDefault();
    event.stopPropagation();
    this.closeOverlay();
  }
},

  toggleOverview() {
    const willShow = !document.body.classList.contains("overview-mode");

    if (willShow) {
      document.body.classList.add("overview-mode");
      this.buildOverview();
    } else {
      document.body.classList.remove("overview-mode");
      this.resetYearToCurrent();
    }

    this.setOverviewButtonLabel();
  },

  resetYearToCurrent() {
    const { yearSelect } = this.dom;
    if (!yearSelect) return;

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;
    this.updateAllAges();

    if (document.body.classList.contains("overview-mode")) {
      this.buildOverview();
    }
  },

   openOverlayFromButton(dayButton) {
  const { overlay, overlayTitle, overlayText, openSound } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  const monthKey = (dayButton.dataset.month || "").trim().toLowerCase();
  const month = monthKey ? monthKey.charAt(0).toUpperCase() + monthKey.slice(1) : "";

  const day = (dayButton.dataset.day || "").trim();
  const type = (dayButton.dataset.type || "").trim().toLowerCase();
  const id = (dayButton.dataset.id || "").trim();

  const birthYearRaw = dayButton.dataset.year;
  const name = (dayButton.dataset.name || "").trim();
  const text = (dayButton.dataset.text || "").trim();

  // Rubrik
  overlayTitle.textContent = day && month ? `${day} ${month}` : (month || "");

  const playOpenSound = () => {
    if (!openSound) return;
    try {
      openSound.currentTime = 0;
      openSound.play();
    } catch {}
  };

  // 1) Anv√§ndarh√§ndelse (event) med id -> visa detaljer + knappar
  if (type === "event" && id) {
    const ev = this.getUserEventById(id);

    const safe = (v) => (v == null ? "" : String(v));
    const title = safe(ev?.title || name);
    const date = safe(ev?.date || "");
    const time = safe(ev?.time || "");
    const place = safe(ev?.place || "");
    const desc = safe(ev?.desc || "");
    const createdBy = safe(ev?.createdBy || "");
    const icon = safe(ev?.icon || "");

    overlayText.innerHTML = `
      <div style="display:grid; gap:0.4rem;">
        <div><strong>${icon ? `${icon} ` : ""}${title}</strong></div>
        ${date ? `<div>Datum: ${date}</div>` : ``}
        ${time ? `<div>Tid: ${time}</div>` : ``}
        ${place ? `<div>Plats: ${place}</div>` : ``}
        ${desc ? `<div>Beskrivning: ${desc}</div>` : ``}
        ${createdBy ? `<div>Skapad av: ${createdBy}</div>` : ``}

        <div style="display:flex; gap:0.5rem; margin-top:0.6rem; justify-content:flex-end;">
          <button type="button" id="eventEditBtn">Redigera</button>
          <button type="button" id="eventDeleteBtn">Ta bort</button>
        </div>
      </div>
    `;

    // √ñppna + l√•s kontroller
    this.lockTopControls();
    overlay.classList.remove("hidden");
    playOpenSound();

    const editBtn = document.getElementById("eventEditBtn");
    const delBtn = document.getElementById("eventDeleteBtn");

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        this.openEventCreateOverlay(ev); // √∂ppna i redigeringsl√§ge
      });
    }

    if (delBtn) {
      delBtn.addEventListener("click", () => {
        const ok = confirm("Ta bort h√§ndelsen?");
        if (!ok) return;

        this.deleteUserEventById(id);
        this.renderMonthsFromEvents();
        this.closeOverlay(); // st√§nger + l√•ser upp kontroller konsekvent
      });
    }

    return;
  }

  // 2) F√∂delsedag
  if (type === "birthday" && birthYearRaw && name) {
    const birthYear = parseInt(birthYearRaw, 10);
    if (!Number.isNaN(birthYear)) {
      const age = this.calculateAge(birthYear);
      overlayText.textContent = `${name} fyller ${age} √•r`;
    } else {
      overlayText.textContent = name;
    }
  } else {
    // 3) √ñvrigt
    overlayText.textContent = text || name || "";
  }

  // √ñppna + l√•s kontroller
  this.lockTopControls();
  overlay.classList.remove("hidden");
  playOpenSound();
},

 openEventCreateOverlay(existingEvent = null) {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  const SIGN_KEY = "arshjul_last_signature_v1";
  const ICON_KEY = "arshjul_last_event_icon_v1";

  const lastSignature = (localStorage.getItem(SIGN_KEY) || "").trim();
  const lastIcon = (localStorage.getItem(ICON_KEY) || "üóìÔ∏è").trim();

  const isEdit = !!(existingEvent && existingEvent.id);

  // √ñppna overlay
  overlay.classList.remove("hidden");
  overlayTitle.textContent = isEdit ? "Redigera h√§ndelse" : "Ny h√§ndelse";

  overlayText.innerHTML = `
    <form id="eventCreateForm" class="event-form" data-edit-id="${isEdit ? String(existingEvent.id) : ""}">
      <div class="event-field">
        <label for="eventTitle">Titel *</label>
        <input id="eventTitle" name="title" type="text" required />
      </div>

      <div class="event-field">
        <label for="eventDate">Datum *</label>
        <input id="eventDate" name="date" type="date" required />
      </div>

      <div class="event-field">
        <label for="eventTime">Tid</label>
        <input id="eventTime" name="time" type="time" step="60" />
      </div>

      <div class="event-field">
        <label for="eventPlace">Plats</label>
        <input id="eventPlace" name="place" type="text" />
      </div>

      <div class="event-field">
        <label for="eventDesc">Beskrivning</label>
        <textarea id="eventDesc" name="desc" rows="3"></textarea>
      </div>

      <div class="event-field">
        <label for="eventIcon">Typ av h√§ndelse</label>
        <select id="eventIcon" name="icon">
          <option value="üóìÔ∏è">üóìÔ∏è Neutral</option>
          <option value="üéâ">üéâ Festlig</option>
        </select>
      </div>

      <div class="event-field">
        <label for="eventCreatedBy">Skapad av *</label>
        <input id="eventCreatedBy" name="createdBy" type="text" required />
      </div>

      <div class="event-actions">
        <button type="button" id="eventCancelBtn">Avbryt</button>
        <button type="submit" id="eventSaveBtn" disabled>Spara</button>
      </div>
    </form>
  `;

  const form = document.getElementById("eventCreateForm");

  const titleEl = document.getElementById("eventTitle");
  const dateEl = document.getElementById("eventDate");
  const timeEl = document.getElementById("eventTime");
  const placeEl = document.getElementById("eventPlace");
  const descEl = document.getElementById("eventDesc");
  const iconEl = document.getElementById("eventIcon");
  const createdByEl = document.getElementById("eventCreatedBy");

  const cancelBtn = document.getElementById("eventCancelBtn");
  const saveBtn = document.getElementById("eventSaveBtn");

  // Prefill: redigera-l√§ge vinner, annars senaste val
  if (isEdit) {
    if (titleEl) titleEl.value = String(existingEvent.title || "");
    if (dateEl) dateEl.value = String(existingEvent.date || "");
    if (timeEl) timeEl.value = String(existingEvent.time || "");
    if (placeEl) placeEl.value = String(existingEvent.place || "");
    if (descEl) descEl.value = String(existingEvent.desc || "");
    if (createdByEl) createdByEl.value = String(existingEvent.createdBy || "");
    if (iconEl) iconEl.value = String(existingEvent.icon || "üóìÔ∏è") === "üéâ" ? "üéâ" : "üóìÔ∏è";
  } else {
    if (createdByEl) createdByEl.value = lastSignature;
    if (iconEl) iconEl.value = lastIcon === "üéâ" ? "üéâ" : "üóìÔ∏è";
  }

  const updateSaveEnabled = () => {
    const titleOk = (titleEl?.value || "").trim().length > 0;
    const dateOk = (dateEl?.value || "").trim().length > 0;
    const createdByOk = (createdByEl?.value || "").trim().length > 0;

    if (saveBtn) saveBtn.disabled = !(titleOk && dateOk && createdByOk);
  };

  [titleEl, dateEl, createdByEl].forEach((el) => {
    if (!el) return;
    el.addEventListener("input", updateSaveEnabled);
  });

  // Avbryt st√§nger overlay (anv√§nd samma st√§nglogik √∂verallt)
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  // Submit: skapa nytt eller uppdatera befintligt
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const title = (titleEl?.value || "").trim();
      const date = (dateEl?.value || "").trim().replace(/\s+/g, "");
      const time = (timeEl?.value || "").trim();
      const place = (placeEl?.value || "").trim();
      const desc = (descEl?.value || "").trim();
      const icon = (iconEl?.value || "üóìÔ∏è").trim();
      const createdBy = (createdByEl?.value || "").trim();

      if (!title || !date || !createdBy) return;

      // Kom ih√•g senaste val
      try {
        localStorage.setItem(SIGN_KEY, createdBy);
        localStorage.setItem(ICON_KEY, icon === "üéâ" ? "üéâ" : "üóìÔ∏è");
      } catch {}

      const editId = (form.dataset.editId || "").trim();

      if (editId) {
        const updatedEvent = {
          id: editId, // <-- beh√•ll samma id
          title,
          date,
          time,
          place,
          desc,
          createdBy,
          icon
        };

        this.updateUserEvent(updatedEvent);
      } else {
        const newEvent = {
          id: `ev_${Date.now()}`,
          title,
          date,
          time,
          place,
          desc,
          createdBy,
          icon
        };

        this.addUserEvent(newEvent);
      }

      if (typeof this.renderMonthsFromEvents === "function") {
        this.renderMonthsFromEvents();
      }

      this.closeOverlay();
    });
  }

  updateSaveEnabled();
}, 
openExportEventsOverlay() {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  const data = this.getUserEvents();
  const json = JSON.stringify(data, null, 2);

  overlay.classList.remove("hidden");
  overlayTitle.textContent = "Exportera h√§ndelser";

  overlayText.innerHTML = `
    <div class="event-form" style="margin-top:0;">
      <div class="event-field">
        <label for="exportJson">Kopiera JSON</label>
        <textarea id="exportJson" rows="10" style="width:100%">${json}</textarea>
      </div>

      <div class="event-actions">
        <button type="button" id="exportCloseBtn">St√§ng</button>
      </div>
    </div>
  `;

  const ta = document.getElementById("exportJson");
  if (ta) {
    ta.focus();
    ta.select();
  }

  const closeBtn = document.getElementById("exportCloseBtn");
  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }
},

openImportEventsOverlay() {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  overlay.classList.remove("hidden");
  overlayTitle.textContent = "Importera h√§ndelser";

  overlayText.innerHTML = `
    <form id="importEventsForm" class="event-form">
      <div class="event-field">
        <label for="importJson">Klistra in JSON</label>
        <textarea id="importJson" rows="10" style="width:100%" placeholder='[{"id":"ev_...","title":"...","date":"YYYY-MM-DD",...}]'></textarea>
      </div>

      <div class="event-actions">
        <button type="button" id="importCancelBtn">Avbryt</button>
        <button type="submit" id="importSaveBtn">Importera</button>
      </div>
    </form>
  `;

  const cancelBtn = document.getElementById("importCancelBtn");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  const form = document.getElementById("importEventsForm");
  const input = document.getElementById("importJson");

  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const raw = (input?.value || "").trim();
      if (!raw) return;

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch {
        alert("Ogiltig JSON. Kontrollera att du klistrat in korrekt format.");
        return;
      }

      if (!Array.isArray(parsed)) {
        alert("JSON m√•ste vara en lista (array) av h√§ndelser.");
        return;
      }

      // Enkel validering + normalisering
      const cleaned = parsed
        .filter((ev) => ev && typeof ev === "object")
        .map((ev) => ({
          id: String(ev.id || `ev_${Date.now()}`),
          title: String(ev.title || "").trim(),
          date: String(ev.date || "").trim(),
          time: String(ev.time || "").trim(),
          place: String(ev.place || "").trim(),
          desc: String(ev.desc || "").trim(),
          createdBy: String(ev.createdBy || "").trim(),
          icon: String(ev.icon || "üóìÔ∏è").trim() === "üéâ" ? "üéâ" : "üóìÔ∏è"
        }))
        .filter((ev) => ev.title && ev.date && ev.createdBy);

      if (cleaned.length === 0) {
        alert("Inget att importera. Kontrollera att varje post har title, date och createdBy.");
        return;
      }

      // Sl√• ihop med befintliga (dedupe sker i getUserEvents)
      const current = this.getUserEvents();
      const merged = [...current, ...cleaned];
      this.setUserEvents(merged);

      this.renderMonthsFromEvents();
      this.closeOverlay();
      alert(`Importerade ${cleaned.length} h√§ndelser.`);
    });
  }
},
getUserEvents() {
  const key = "arshjul_user_events_v1";

  const normText = (s) =>
    String(s ?? "")
      .replace(/[\u200B-\u200D\uFEFF]/g, "") // tar bort zero-width tecken
      .trim();

  const toISODate = (s) => {
    const raw = normText(s).replace(/\s+/g, "");
    // F√∂rv√§ntar "YYYY-MM-DD" men hanterar √§ven "YYYY-M-D"
    const m = raw.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (!m) return raw;
    const yyyy = m[1];
    const mm = String(m[2]).padStart(2, "0");
    const dd = String(m[3]).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  };

  const sig = (ev) => {
    const date = toISODate(ev?.date);
    const title = normText(ev?.title).toLowerCase().replace(/\s+/g, " ");
    const time = normText(ev?.time).toLowerCase().replace(/\s+/g, " ");
    const place = normText(ev?.place).toLowerCase().replace(/\s+/g, " ");
    const desc = normText(ev?.desc).toLowerCase().replace(/\s+/g, " ");
    const createdBy = normText(ev?.createdBy).toLowerCase().replace(/\s+/g, " ");
    return [date, title, time, place, desc, createdBy].join("|");
  };

  try {
    const raw = localStorage.getItem(key);
    const parsed = raw ? JSON.parse(raw) : [];
    const arr = Array.isArray(parsed) ? parsed : [];

    // 1) Normalisera f√§lt (framf√∂r allt date)
    const normalized = arr.map((ev) => {
      if (!ev || typeof ev !== "object") return ev;
      return {
        ...ev,
        title: normText(ev.title),
        date: toISODate(ev.date),
        time: normText(ev.time),
        place: normText(ev.place),
        desc: normText(ev.desc),
        createdBy: normText(ev.createdBy),
      };
    });

    // 2) Deduplicera (beh√•ll f√∂rsta f√∂rekomsten)
    const seen = new Set();
    const cleaned = [];
    for (const ev of normalized) {
      const k = sig(ev);
      if (seen.has(k)) continue;
      seen.add(k);
      cleaned.push(ev);
    }

    // 3) Skriv tillbaka om n√•got √§ndrades (st√§dning permanent)
    const changed =
      cleaned.length !== arr.length ||
      JSON.stringify(cleaned) !== JSON.stringify(arr);

    if (changed) {
      localStorage.setItem(key, JSON.stringify(cleaned));
    }

    return cleaned;
  } catch {
    return [];
  }
},

setUserEvents(events) {
  try {
    localStorage.setItem("arshjul_user_events_v1", JSON.stringify(events));
  } catch {
    // ignorera (t.ex. om storage √§r blockerat)
  }
},

addUserEvent(ev) {
  const norm = (s) => String(s || "").trim().toLowerCase().replace(/\s+/g, " ");
  const normDate = (s) => String(s || "").trim().replace(/\s+/g, "");

  const current = this.getUserEvents();

  const sig = [
    normDate(ev.date),
    norm(ev.title),
    norm(ev.time),
    norm(ev.place),
    norm(ev.desc),
    norm(ev.createdBy)
  ].join("|");

  const exists = current.some((x) => {
    const sigX = [
      normDate(x.date),
      norm(x.title),
      norm(x.time),
      norm(x.place),
      norm(x.desc),
      norm(x.createdBy)
    ].join("|");
    return sigX === sig;
  });

  if (exists) return; // redan sparad

  current.push(ev);
  this.setUserEvents(current);
},

getUserEventById(id) {
  const arr = this.getUserEvents();
  return arr.find((e) => e && e.id === id) || null;
},

updateUserEvent(updated) {
  const arr = this.getUserEvents();
  const idx = arr.findIndex((e) => e && e.id === updated.id);
  if (idx === -1) return false;

  arr[idx] = updated;
  this.setUserEvents(arr);
  return true;
},

deleteUserEventById(id) {
  const arr = this.getUserEvents();
  const next = arr.filter((e) => e && e.id !== id);
  this.setUserEvents(next);
  return next.length !== arr.length;
},

 closeOverlay() {
  const { overlay } = this.dom;
  if (!overlay) return;

  overlay.classList.add("hidden");
  this.unlockTopControls();

  if (!document.body.classList.contains("overview-mode") && this.selectedYear !== this.currentYear) {
    this.resetYearToCurrent();
  }
},

  bindEvents() {
  const {
    toggleOverviewBtn,
    closeBtn,
    overlay,
    printBtn,
    copyBtn,
    addEventBtn,
    exportEventsBtn,
    importEventsBtn
  } = this.dom;

  if (toggleOverviewBtn) {
    toggleOverviewBtn.addEventListener("click", () => {
      this.toggleOverview();
    });
  }

  if (addEventBtn) {
    addEventBtn.addEventListener("click", () => {
      this.openEventCreateOverlay();
    });
  }

  document.addEventListener("click", (event) => {
    this.handleDocumentClick(event);
  });

  if (closeBtn && overlay) {
    closeBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  if (overlay) {
    overlay.addEventListener(
      "click",
      (event) => {
        this.handleOverlayClick(event);
      },
      true // capture: stoppar click-through s√§krare
    );
  }

  document.addEventListener("keydown", (event) => {
    this.handleKeydown(event);
  });

  window.addEventListener("beforeprint", () => {
    this.handleBeforePrint();
  });

  window.addEventListener("afterprint", () => {
    this.resetPrintFlags();
  });

  if (printBtn) {
    printBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.printBirthdaysOnly();
    });
  }

  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;

      try {
        const text = this.buildBirthdaysText();
        const ok = await this.copyBirthdaysToClipboard();

        if (!ok) {
          this.showCopyHelper(text);
        }
      } catch (e) {
        console.error("Fel vid kopiering av f√∂delsedagslista:", e);
      }
    });
  }

  if (exportEventsBtn) {
    exportEventsBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openExportEventsOverlay();
    });
  }

  if (importEventsBtn) {
    importEventsBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openImportEventsOverlay();
    });
  }
},

  init() {
    this.selectedYear = this.currentYear;
    this.cacheDom();

    this.renderMonthsFromEvents();

    this.bindEvents();
    this.initYearSelect();
    this.updateAllAges();
    this.setOverviewButtonLabel();
  }
};

window.addEventListener("load", () => {
  App.init();
});
</script>

<audio id="openSound" preload="none">
  <source data-src="./pop.mp3" type="audio/mpeg">
</audio>

</body>
</html>
