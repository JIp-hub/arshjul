<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <title>√Örshjul</title>
<style>
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    line-height: 1.5;
    margin: 2rem;
  }

  h1 {
    margin-bottom: 1.25rem;
  }

  /* Controls */
  .controls {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 1.25rem;
  }

  .controls button,
  .controls select,
  .controls input {
    font: inherit;
  }

  .admin-only {
    display: none;
  }

  body.admin-mode .admin-only {
    display: inline-block;
  }
/* N√§r overlay √§r √∂ppen: inga klick p√• toppkontroller */
body.controls-locked .controls {
  pointer-events: none;
}

body.controls-locked .controls button,
body.controls-locked .controls select,
body.controls-locked .controls input,
body.controls-locked .controls label {
  opacity: 0.5;
}

  /* Months list */
  section {
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #ddd;
  }

  h2 {
    margin-bottom: 0.5rem;
  }

  ul {
    margin: 0;
    padding-left: 1.2rem;
  }

  li {
    margin-bottom: 0.3rem;
  }

  .day-item {
    all: unset;
    display: grid;
    grid-template-columns: 2.5em 1.8em auto;
    align-items: center;
    width: 100%;
    cursor: pointer;
  }

  .day {
    min-width: 2em;
    display: inline-block;
  }

  .icon {
    width: 1.8em;
    text-align: center;
  }

/* Overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 20000;
  }

  .overlay-content {
    position: relative;
    z-index: 20001;
  }

.overlay-content {
  background: white;
  padding: 1.5rem;
  max-width: 420px;
  width: 90%;
  border-radius: 8px;
}

.hidden {
  display: none;
}

/* Event form (Steg 1) */
.event-form {
  display: grid;
  gap: 0.75rem;
  margin-top: 0.75rem;
}

.event-field {
  display: grid;
  gap: 0.25rem;
}

.event-field label {
  font-weight: 600;
  font-size: 0.95rem;
}

.event-field input,
.event-field select,
.event-field textarea {
  font: inherit;
  padding: 0.5rem 0.6rem;
  border: 1px solid #ccc;
  border-radius: 6px;
}

.event-field textarea {
  resize: vertical;
}

.event-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 0.25rem;
}

.event-actions button {
  font: inherit;
  padding: 0.5rem 0.75rem;
}

  /* ===== OVERVIEW MODE (aktiveras senare med JS) ===== */
  #overview {
    display: none;
    margin-top: 1rem;
  }

  body.overview-mode #months {
    display: none;
  }

  body.overview-mode #overview {
    display: block;
  }

  .overview-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 1rem;
  }

  @media (max-width: 900px) {
    .overview-grid {
      grid-template-columns: 1fr;
    }
  }

  .overview-month {
    border: 1px solid #eee;
    padding: 0.75rem;
    border-radius: 8px;
  }

  .overview-month h2 {
    margin: 0 0 0.4rem 0;
    font-size: 1.1rem;
  }

  .overview-month ul {
    padding-left: 1.1rem;
  }

  .overview-month li {
    margin-bottom: 0.2rem;
  }

  /* D√∂lj √•lder i normal vy */
  .age {
    display: none !important;
  }

/* D√∂lj print-vyn i normalvy */
#printMeta,
#printWrap {
  display: none;
}

/* ===== PRINT ===== */
@media print {

  /* D√∂lj kontroller + overlay + originalvyn (vi skriver ut print-wrappern i st√§llet) */
  .controls,
  #overview,
  #overlay,
  #months {
    display: none !important;
  }

  /* Visa print-wrappern */
  #printMeta {
    display: block !important;
  }

  #printWrap {
    display: flex !important;
  }

  /* Bas f√∂r sidan (st√∂rre text, men h√•ll 1 sida) */
  body {
    font-size: 12.5pt !important;
    line-height: 1.25 !important;
    margin: 10mm !important;
  }

  h1 {
    font-size: 18pt !important;
    margin: 0 0 2mm 0 !important;
  }

  /* Tydlig rad med valt √•r */
  #printMeta {
    font-size: 12.5pt !important;
    margin: 0 0 6mm 0 !important;
  }

  /* Tv√• kolumner */
  #printWrap {
    gap: 14mm;
    align-items: flex-start;
  }

  .print-col {
    flex: 1 1 0;
    min-width: 0;
  }

  /* M√•nadskort i print */
  .print-month {
    break-inside: avoid;
    page-break-inside: avoid;
  }

  .print-month h2 {
    margin: 0 0 2.5mm 0 !important;
    font-size: 14pt !important;
  }

  .print-month ul {
    margin: 0 !important;
    padding-left: 0 !important;
    list-style: none !important;
  }

  .print-month li {
    margin: 0 0 1.75mm 0 !important;
  }

  hr {
    display: none !important;
  }
}
/* Tydlig visuell indikator n√§r toppkontroller √§r l√•sta */
body.controls-locked .controls {
  opacity: 0.55;
  pointer-events: none;
}

body.controls-locked #copyHelperOverlay {
  pointer-events: auto;
  opacity: 1;
}

</style>
  
</head>
<body>

<h1>√Örshjul</h1>

<div class="controls">
  <button id="printBirthdaysBtn" type="button">
    Skriv ut ‚Äì endast f√∂delsedagar
  </button>
  <button id="copyBirthdaysBtn" type="button">Kopiera f√∂delsedagslista</button>

  <button id="addEventBtn" type="button">L√§gg till h√§ndelse</button>

  <button id="exportEventsBtn" type="button">Exportera h√§ndelser</button>
  <button id="importEventsBtn" type="button">Importera h√§ndelser</button>
  <button id="exportBirthdaysBtn" class="admin-only" type="button">Exportera f√∂delsedagar</button>
  <button id="importBirthdaysBtn" class="admin-only" type="button">Importera f√∂delsedagar</button>
  <button id="exitAdminBtn" class="admin-only" type="button">Avsluta admin</button>

  <button id="toggleOverviewBtn" type="button">
    Visa √∂versikt
  </button>

  <label class="year-control" for="yearSelect">√Ör:</label>
  <select id="yearSelect" class="year-control" aria-label="V√§lj √•r"></select>

  <label class="admin-only" for="familyCodeInput">Familj:</label>
  <input class="admin-only" id="familyCodeInput" type="text" value="default" size="10" aria-label="Familjekod">
  <button class="admin-only" id="setFamilyCodeBtn" type="button">Byt familj</button>
</div>

<!-- Print-only (byggs av JS precis innan utskrift) -->
<div id="printMeta" class="print-only"></div>
<div id="printWrap" class="print-only"></div>

<main id="months">

<section data-month="januari">
  <h2>Januari</h2>
  <ul></ul>
</section>

<section data-month="februari">
  <h2>Februari</h2>
  <ul></ul>
</section>

<section data-month="mars">
  <h2>Mars</h2>
  <ul></ul>
</section>

<section data-month="april">
  <h2>April</h2>
  <ul></ul>
</section>

<section data-month="maj">
  <h2>Maj</h2>
  <ul></ul>
</section>

<section data-month="juni">
  <h2>Juni</h2>
  <ul></ul>
</section>

<section data-month="juli">
  <h2>Juli</h2>
  <ul></ul>
</section>

<section data-month="augusti">
  <h2>Augusti</h2>
  <ul></ul>
</section>

<section data-month="september">
  <h2>September</h2>
  <ul></ul>
</section>

<section data-month="oktober">
  <h2>Oktober</h2>
  <ul></ul>
</section>

<section data-month="november">
  <h2>November</h2>
  <ul></ul>
</section>

<section data-month="december">
  <h2>December</h2>
  <ul></ul>
</section>

</main>

<!-- Overview (visas n√§r body har klassen overview-mode) -->
<div id="overview">
  <div class="overview-grid" id="overviewGrid"></div>
</div>

<div id="overlay" class="overlay hidden">

  <div class="overlay-content">
    <button id="closeOverlay">St√§ng √ó</button>
    <h2 id="overlayTitle">Februari</h2>
    <p id="overlayText">H√§r ska informationen om februari visas.</p>
  </div>
</div>

<script>
const App = {
  /* =========================
     0. STATE
  ========================= */
  currentYear: new Date().getFullYear(),
  selectedYear: null,
  _isPreparingPrint: false,
  familyCodeStorageKey: "arshjul_family_code_v1",
  adminModeStorageKey: "arshjul_admin_mode_v1",
  defaultFamilyCode: "default",
  currentFamilyCode: "default",

    monthOrder: [
    "januari",
    "februari",
    "mars",
    "april",
    "maj",
    "juni",
    "juli",
    "augusti",
    "september",
    "oktober",
    "november",
    "december"
  ],

  // Anv√§nds n√§r vi mappar YYYY-MM-DD -> m√•nad i text
  monthNames: [
    "januari",
    "februari",
    "mars",
    "april",
    "maj",
    "juni",
    "juli",
    "augusti",
    "september",
    "oktober",
    "november",
    "december"
  ],

  selectors: {
    monthSections: "#months > section",
    birthdayButtons: '.day-item[data-type="birthday"]'
  },

  // Publik fallback-data (privata f√∂delsedagar ska lagras i localStorage)
  demoBirthdays: [
  // DEMO-data (publik version). L√§gg din privata familjedata lokalt, inte i repo.
  { name: "Person A", year: 1990, month: 1, day: 3 },
  { name: "Person B", year: 2000, month: 2, day: 6 },
  { name: "Person C", year: 1985, month: 3, day: 10 },
  { name: "Person D", year: 2010, month: 3, day: 12 },
  { name: "Person E", year: 1995, month: 5, day: 14 },
  { name: "Person F", year: 1988, month: 5, day: 18 },
  { name: "Person G", year: 2021, month: 7, day: 30 },
  { name: "Person H", year: 2007, month: 8, day: 3 },
  { name: "Person I", year: 1987, month: 8, day: 7 },
  { name: "Person J", year: 2005, month: 9, day: 1 },
  { name: "Person K", year: 1982, month: 9, day: 4 },
  { name: "Person L", year: 1971, month: 11, day: 6 },
  { name: "Person M", year: 1992, month: 11, day: 14 },
  { name: "Person N", year: 2019, month: 12, day: 5 },
  { name: "Person O", year: 1949, month: 12, day: 9 }
],
  /* =========================
     1. DOM REFERENCES
  ========================= */
  dom: {
    overlay: null,
    overlayTitle: null,
    overlayText: null,
    closeBtn: null,

    printBtn: null,
    copyBtn: null,
    addEventBtn: null,

    exportEventsBtn: null,
    importEventsBtn: null,
    exportBirthdaysBtn: null,
    importBirthdaysBtn: null,
    exitAdminBtn: null,
    familyCodeInput: null,
    setFamilyCodeBtn: null,

    openSound: null,
    yearSelect: null,
    toggleOverviewBtn: null,
    overviewGrid: null,
    printMeta: null,
    printWrap: null
  },

  /* ===== DATASTORE (EVENTS) ===== */
  dataStore: {
    events: {
      baseKey: "arshjul_user_events_v1",

      getKey() {
        const familyCode =
          typeof App.getCurrentFamilyCode === "function"
            ? App.getCurrentFamilyCode()
            : "default";

        const safe = String(familyCode ?? "").trim() || "default";
        return `${this.baseKey}::${safe}`;
      },

            _writeEvents(events) {
        try {
          localStorage.setItem(this.getKey(), JSON.stringify(events));
        } catch {
          // ignorera (t.ex. om storage √§r blockerat)
        }
      },

replaceEvents(events) {
  const arr = Array.isArray(events) ? events : [];
  this._writeEvents(arr);
},
      listEvents() {
        const normText = (s) =>
          String(s ?? "")
            .replace(/[\u200B-\u200D\uFEFF]/g, "") // tar bort zero-width tecken
            .trim();

        const toISODate = (s) => {
          const raw = normText(s).replace(/\s+/g, "");
          // F√∂rv√§ntar "YYYY-MM-DD" men hanterar √§ven "YYYY-M-D"
          const m = raw.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
          if (!m) return raw;
          const yyyy = m[1];
          const mm = String(m[2]).padStart(2, "0");
          const dd = String(m[3]).padStart(2, "0");
          return `${yyyy}-${mm}-${dd}`;
        };

        const sig = (ev) => {
          const date = toISODate(ev?.date);
          const title = normText(ev?.title).toLowerCase().replace(/\s+/g, " ");
          const time = normText(ev?.time).toLowerCase().replace(/\s+/g, " ");
          const place = normText(ev?.place).toLowerCase().replace(/\s+/g, " ");
          const desc = normText(ev?.desc).toLowerCase().replace(/\s+/g, " ");
          const createdBy = normText(ev?.createdBy).toLowerCase().replace(/\s+/g, " ");
          return [date, title, time, place, desc, createdBy].join("|");
        };

        try {
          const raw = localStorage.getItem(this.getKey());
          const parsed = raw ? JSON.parse(raw) : [];
          const arr = Array.isArray(parsed) ? parsed : [];

          // 1) Normalisera f√§lt (framf√∂r allt date)
          const normalized = arr.map((ev) => {
            if (!ev || typeof ev !== "object") return ev;
            return {
              ...ev,
              title: normText(ev.title),
              date: toISODate(ev.date),
              time: normText(ev.time),
              place: normText(ev.place),
              desc: normText(ev.desc),
              createdBy: normText(ev.createdBy),
            };
          });

          // 2) Deduplicera (beh√•ll f√∂rsta f√∂rekomsten)
          const seen = new Set();
          const cleaned = [];
          for (const ev of normalized) {
            const k = sig(ev);
            if (seen.has(k)) continue;
            seen.add(k);
            cleaned.push(ev);
          }

          // 3) Skriv tillbaka om n√•got √§ndrades (st√§dning permanent)
          const changed =
            cleaned.length !== arr.length ||
            JSON.stringify(cleaned) !== JSON.stringify(arr);

          if (changed) {
            this._writeEvents(cleaned);
          }

          return cleaned;
        } catch {
          return [];
        }
      },

      createEvent(event) {
        const arr = this.listEvents();
        arr.push(event);
        this._writeEvents(arr);
      },

      updateEvent(id, patchOrEvent) {
        const arr = this.listEvents();
        const idx = arr.findIndex((ev) => ev && ev.id === id);
        if (idx === -1) return false;

        arr[idx] =
          patchOrEvent && typeof patchOrEvent === "object" && !Array.isArray(patchOrEvent)
            ? { ...arr[idx], ...patchOrEvent }
            : patchOrEvent;

        this._writeEvents(arr);
        return true;
      },

      deleteEvent(id) {
        const arr = this.listEvents();
        const next = arr.filter((ev) => ev && ev.id !== id);
        this._writeEvents(next);
        return next.length !== arr.length;
      }
    },

    birthdays: {
      baseKey: "arshjul_birthdays_v1",

      getKey() {
        const familyCode =
          typeof App.getCurrentFamilyCode === "function"
            ? App.getCurrentFamilyCode()
            : "default";

        const safe = String(familyCode ?? "").trim() || "default";
        return `${this.baseKey}::${safe}`;
      },

      _normalizeBirthday(entry) {
        if (!entry || typeof entry !== "object") return null;

        const name = String(entry.name || "").trim();
        const month = Number.parseInt(entry.month, 10);
        const day = Number.parseInt(entry.day, 10);

        if (!name || Number.isNaN(month) || Number.isNaN(day)) return null;
        if (month < 1 || month > 12 || day < 1 || day > 31) return null;

        const parsedYear =
          entry.year === null || String(entry.year).trim() === ""
            ? null
            : Number.parseInt(entry.year, 10);
        const year = Number.isNaN(parsedYear) ? null : parsedYear;

        return { name, month, day, year };
      },

      _dedupe(list) {
        const seen = new Set();
        const out = [];

        list.forEach((entry) => {
          const normalized = this._normalizeBirthday(entry);
          if (!normalized) return;

          const key = normalized.year == null
            ? `${normalized.name.toLowerCase()}|${normalized.month}|${normalized.day}`
            : `${normalized.name.toLowerCase()}|${normalized.month}|${normalized.day}|${normalized.year}`;

          if (seen.has(key)) return;
          seen.add(key);
          out.push(normalized);
        });

        return out;
      },

      _writeBirthdays(list) {
        try {
          const normalized = this._dedupe(Array.isArray(list) ? list : []);
          localStorage.setItem(this.getKey(), JSON.stringify(normalized));
        } catch {
          // ignorera
        }
      },

      listBirthdays() {
        try {
          const raw = localStorage.getItem(this.getKey());
          if (!raw) return this._dedupe(App.demoBirthdays || []);

          const parsed = JSON.parse(raw);
          const arr = Array.isArray(parsed) ? parsed : [];
          return this._dedupe(arr);
        } catch {
          return this._dedupe(App.demoBirthdays || []);
        }
      },

      importBirthdays(list) {
        const normalized = this._dedupe(Array.isArray(list) ? list : []);
        this._writeBirthdays(normalized);
        return normalized;
      },

      exportBirthdays() {
        return this.listBirthdays();
      }
    }
  },

  /* ==========================
     2. FUNCTIONS
  ========================= */
sanitizeFamilyCode(rawCode) {
  const code = String(rawCode || "").trim();
  return code || this.defaultFamilyCode;
},

getCurrentFamilyCode() {
  return this.sanitizeFamilyCode(this.currentFamilyCode);
},

loadFamilyCode() {
  let stored = this.defaultFamilyCode;
  try {
    stored = localStorage.getItem(this.familyCodeStorageKey) || this.defaultFamilyCode;
  } catch {
    stored = this.defaultFamilyCode;
  }

  this.currentFamilyCode = this.sanitizeFamilyCode(stored);
  return this.currentFamilyCode;
},

setFamilyCode(nextCode) {
  const normalized = this.sanitizeFamilyCode(nextCode);
  this.currentFamilyCode = normalized;

  try {
    localStorage.setItem(this.familyCodeStorageKey, normalized);
  } catch {
    // ignorera
  }

  if (this.dom.familyCodeInput) {
    this.dom.familyCodeInput.value = normalized;
  }

  this.renderMonthsFromEvents();
  this.updateAllAges();
  if (document.body.classList.contains("overview-mode")) {
    this.buildOverview();
  }
},

cacheDom() {
  this.dom.overlay = document.getElementById("overlay");
  this.dom.overlayTitle = document.getElementById("overlayTitle");
  this.dom.overlayText = document.getElementById("overlayText");
  this.dom.closeBtn = document.getElementById("closeOverlay");
  this.dom.printBtn = document.getElementById("printBirthdaysBtn");
  this.dom.copyBtn = document.getElementById("copyBirthdaysBtn");
  this.dom.addEventBtn = document.getElementById("addEventBtn");

  this.dom.exportEventsBtn = document.getElementById("exportEventsBtn");
  this.dom.importEventsBtn = document.getElementById("importEventsBtn");
  this.dom.exportBirthdaysBtn = document.getElementById("exportBirthdaysBtn");
  this.dom.importBirthdaysBtn = document.getElementById("importBirthdaysBtn");
  this.dom.exitAdminBtn = document.getElementById("exitAdminBtn");
  this.dom.familyCodeInput = document.getElementById("familyCodeInput");
  this.dom.setFamilyCodeBtn = document.getElementById("setFamilyCodeBtn");

  this.dom.openSound = document.getElementById("openSound");
  this.dom.yearSelect = document.getElementById("yearSelect");
  this.dom.toggleOverviewBtn = document.getElementById("toggleOverviewBtn");
  this.dom.overviewGrid = document.getElementById("overviewGrid");
  this.dom.printMeta = document.getElementById("printMeta");
  this.dom.printWrap = document.getElementById("printWrap");

  // Ljud: undvik fel i file://
  if (this.dom.openSound) {
    const source = this.dom.openSound.querySelector("source");
    if (source) {
      if (location.protocol === "file:") {
        source.removeAttribute("src");
      } else {
        const ds = source.getAttribute("data-src");
        if (ds) source.setAttribute("src", ds);
      }
    }
    this.dom.openSound.load();
  }
},

    lockTopControls() {
  document.body.classList.add("controls-locked");
  if (this.dom.yearSelect) this.dom.yearSelect.disabled = true;
  if (this.dom.printBtn) this.dom.printBtn.disabled = true;
  if (this.dom.copyBtn) this.dom.copyBtn.disabled = true;
  if (this.dom.toggleOverviewBtn) this.dom.toggleOverviewBtn.disabled = true;
  if (this.dom.addEventBtn) this.dom.addEventBtn.disabled = true;

  if (this.dom.exportEventsBtn) this.dom.exportEventsBtn.disabled = true;
  if (this.dom.importEventsBtn) this.dom.importEventsBtn.disabled = true;
  if (this.dom.familyCodeInput) this.dom.familyCodeInput.disabled = true;
  if (this.dom.setFamilyCodeBtn) this.dom.setFamilyCodeBtn.disabled = true;
  if (this.dom.exportBirthdaysBtn) this.dom.exportBirthdaysBtn.disabled = true;
  if (this.dom.importBirthdaysBtn) this.dom.importBirthdaysBtn.disabled = true;
},

 unlockTopControls() {
  document.body.classList.remove("controls-locked");
  if (this.dom.yearSelect) this.dom.yearSelect.disabled = false;
  if (this.dom.printBtn) this.dom.printBtn.disabled = false;
  if (this.dom.copyBtn) this.dom.copyBtn.disabled = false;
  if (this.dom.toggleOverviewBtn) this.dom.toggleOverviewBtn.disabled = false;
  if (this.dom.addEventBtn) this.dom.addEventBtn.disabled = false;

  if (this.dom.exportEventsBtn) this.dom.exportEventsBtn.disabled = false;
  if (this.dom.importEventsBtn) this.dom.importEventsBtn.disabled = false;
  if (this.dom.familyCodeInput) this.dom.familyCodeInput.disabled = false;
  if (this.dom.setFamilyCodeBtn) this.dom.setFamilyCodeBtn.disabled = false;
  if (this.dom.exportBirthdaysBtn) this.dom.exportBirthdaysBtn.disabled = false;
  if (this.dom.importBirthdaysBtn) this.dom.importBirthdaysBtn.disabled = false;
},

exitAdminMode() {
  document.body.classList.remove("admin-mode");

  try {
    const url = new URL(window.location.href);
    url.searchParams.delete("admin");
    history.replaceState({}, "", url.toString());
  } catch {}
},

applyAdminMode() {
  let isAdminFromUrl = false;
  try {
    const params = new URLSearchParams(window.location.search);
    isAdminFromUrl = params.get("admin") === "1";
  } catch {
    isAdminFromUrl = false;
  }

  if (!isAdminFromUrl) {
    document.body.classList.remove("admin-mode");
    return;
  }

  document.body.classList.add("admin-mode");
},

  calculateAge(birthYear) {
    const y = Number.isFinite(this.selectedYear) ? this.selectedYear : this.currentYear;
    return y - birthYear;
  },

  getBirthdayAgeText(year) {
    if (year == null) return "";
    const birthYear = parseInt(String(year), 10);
    if (Number.isNaN(birthYear)) return "";
    return `${this.calculateAge(birthYear)} √•r`;
  },

  getBirthdayEvents() {
    return this.dataStore.birthdays.listBirthdays().map((b) => ({
      type: "birthday",
      day: b.day,
      month: this.monthNames[b.month - 1],
      year: b.year,
      name: b.name
    })).filter((b) => b.month);
  },

  getCombinedEvents() {
    const baseEvents = this.getBirthdayEvents();
    const userRaw = this.getUserEvents();
    const userEvents = userRaw
      .map((ev) => {
        if (!ev || !ev.date) return null;
        const parts = String(ev.date).split("-");
        if (parts.length !== 3) return null;
        const y = Number(parts[0]);
        const m = Number(parts[1]);
        const d = Number(parts[2]);
        if (!y || !m || !d) return null;
        const monthName = this.monthNames?.[m - 1];
        if (!monthName) return null;
        return {
          ...ev,
          type: "event",
          icon: ev.icon || "üóìÔ∏è",
          year: y,
          month: monthName,
          day: d,
          name: ev.title || "H√§ndelse",
          text:
            (ev.time ? `${ev.time} ` : "") +
            (ev.place ? `${ev.place} ` : "") +
            (ev.desc ? `${ev.desc}` : ""),
          createdBy: ev.createdBy || ""
        };
      })
      .filter(Boolean);

    return [...baseEvents, ...userEvents];
  },

  getIconForType(type, fallbackIcon = "") {
  const fb = String(fallbackIcon || "").trim();
  if (fb) return fb; // <-- anv√§ndarens val ska vinna

  const t = String(type || "").toLowerCase();
  const iconMap = {
    birthday: "üéÇ",
    event: "üóìÔ∏è",
    reminder: "‚è∞",
    holiday: "üéâ",
    note: "‚≠ê"
  };
  return iconMap[t] || "";
},

  createDayItemButton(ev) {
  const btn = document.createElement("button");
  btn.className = "day-item";
  btn.type = "button";

  btn.dataset.day = String(ev.day);
  btn.dataset.month = String(ev.month);
  btn.dataset.type = String(ev.type);

  if (ev.id != null) btn.dataset.id = String(ev.id);
  if (ev.year != null) btn.dataset.year = String(ev.year);
  if (ev.name != null) btn.dataset.name = String(ev.name);
  if (ev.text != null) btn.dataset.text = String(ev.text);
  if (ev.icon != null) btn.dataset.icon = String(ev.icon);

  const daySpan = document.createElement("span");
  daySpan.className = "day";
  daySpan.textContent = String(ev.day);

  const iconSpan = document.createElement("span");
  iconSpan.className = "icon";
  iconSpan.textContent = this.getIconForType(ev.type, ev.icon);

  const textSpan = document.createElement("span");
  textSpan.className = "text";
  textSpan.textContent = ev.name ? String(ev.name) : (ev.text ? String(ev.text) : "");

  const ageSpan = document.createElement("span");
  ageSpan.className = "age";
  ageSpan.textContent = "";

  btn.appendChild(daySpan);
  btn.appendChild(iconSpan);
  btn.appendChild(textSpan);
  btn.appendChild(ageSpan);

  return btn;
},

  initYearSelect() {
    const yearSelect = this.dom.yearSelect;
    if (!yearSelect) return;

    const startYear = this.currentYear - 10;
    const endYear = this.currentYear + 10;

    yearSelect.innerHTML = "";

    for (let y = startYear; y <= endYear; y++) {
      const opt = document.createElement("option");
      opt.value = String(y);
      opt.textContent = String(y);
      yearSelect.appendChild(opt);
    }

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;

    yearSelect.addEventListener("change", () => {
      this.selectedYear = parseInt(yearSelect.value, 10);
      this.updateAllAges();

      if (document.body.classList.contains("overview-mode")) {
        this.buildOverview();
      }
    });

    yearSelect.addEventListener(
      "wheel",
      (event) => {
        event.preventDefault();
      },
      { passive: false }
    );
  },

  updateAllAges() {
    const buttons = document.querySelectorAll(this.selectors.birthdayButtons);

    buttons.forEach((btn) => {
      const ageSpan = btn.querySelector(".age");
      if (!ageSpan) return;
      const ageText = this.getBirthdayAgeText(btn.dataset.year);
      ageSpan.textContent = ageText ? ` ${ageText}` : "";
    });
  },

  setOverviewButtonLabel() {
    const btn = this.dom.toggleOverviewBtn;
    if (!btn) return;

    const isOverview = document.body.classList.contains("overview-mode");
    btn.textContent = isOverview ? "Tillbaka till lista" : "Visa √∂versikt";
  },

  renderMonthsFromEvents() {
  const monthsRoot = document.getElementById("months");
  if (!monthsRoot) return;

  const byMonth = new Map();
  this.monthOrder.forEach((m) => byMonth.set(m, []));

  const allEvents = this.getCombinedEvents();

  allEvents.forEach((ev) => {
    if (!ev || !ev.month) return;
    const monthKey = String(ev.month).toLowerCase().trim();
    if (!byMonth.has(monthKey)) return;
    byMonth.get(monthKey).push(ev);
  });

  const sections = Array.from(document.querySelectorAll(this.selectors.monthSections));

  sections.forEach((section) => {
    const monthKey = (section.dataset.month || "").toLowerCase().trim();
    const ul = section.querySelector("ul");
    if (!ul) return;

    ul.innerHTML = "";

    const monthEvents = byMonth.get(monthKey) || [];

    monthEvents.sort((a, b) => {
      const da = a.day || 0;
      const db = b.day || 0;
      if (da !== db) return da - db;

      const pa = a.type === "birthday" ? 0 : 1;
      const pb = b.type === "birthday" ? 0 : 1;
      return pa - pb;
    });

    if (monthEvents.length === 0) {
      const li = document.createElement("li");
      li.dataset.type = "empty";

      const day = document.createElement("span");
      day.className = "day";
      day.textContent = "";

      const icon = document.createElement("span");
      icon.className = "icon";
      icon.textContent = "";

      const text = document.createElement("span");
      text.className = "text";
      text.textContent = "Inga h√§ndelser √§nnu";

      li.appendChild(day);
      li.appendChild(icon);
      li.appendChild(text);

      ul.appendChild(li);
      return;
    }

    monthEvents.forEach((ev) => {
      const li = document.createElement("li");
      const btn = this.createDayItemButton(ev);
      li.appendChild(btn);
      ul.appendChild(li);
    });
  });
},

  buildOverview() {
  const overviewGrid = this.dom.overviewGrid;
  if (!overviewGrid) return;

  overviewGrid.innerHTML = "";

  const byMonth = new Map();
  this.monthOrder.forEach((m) => byMonth.set(m, []));

  const allEvents = this.getCombinedEvents();

  allEvents.forEach((ev) => {
    if (!ev || !ev.month) return;
    const monthKey = String(ev.month).toLowerCase().trim();
    if (!byMonth.has(monthKey)) return;
    byMonth.get(monthKey).push(ev);
  });

  this.monthOrder.forEach((monthKey) => {
    const monthEvents = byMonth.get(monthKey) || [];
    if (monthEvents.length === 0) return;

    monthEvents.sort((a, b) => {
      const da = a.day || 0;
      const db = b.day || 0;
      if (da !== db) return da - db;

      const pa = a.type === "birthday" ? 0 : 1;
      const pb = b.type === "birthday" ? 0 : 1;
      return pa - pb;
    });

    const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

    const monthDiv = document.createElement("div");
    monthDiv.className = "overview-month";

    const h2 = document.createElement("h2");
    h2.textContent = monthTitle;

    const ul = document.createElement("ul");

    monthEvents.forEach((ev) => {
      const li = document.createElement("li");
      const btn = this.createDayItemButton(ev);
      li.appendChild(btn);
      ul.appendChild(li);
    });

    if (ul.children.length === 0) return;

    monthDiv.appendChild(h2);
    monthDiv.appendChild(ul);
    overviewGrid.appendChild(monthDiv);
  });

  this.updateAllAges();
},

  async copyBirthdaysToClipboard() {
    const text = this.buildBirthdaysText();

    if (location.protocol === "file:") {
      return false;
    }

    if (navigator.clipboard && typeof navigator.clipboard.writeText === "function") {
      try {
        await navigator.clipboard.writeText(text);
        return true;
      } catch (e) {
        // fall through
      }
    }

    const ta = document.createElement("textarea");
    ta.value = text;

    ta.style.position = "fixed";
    ta.style.top = "0";
    ta.style.left = "0";
    ta.style.width = "1px";
    ta.style.height = "1px";
    ta.style.opacity = "0";

    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    ta.setSelectionRange(0, ta.value.length);

    let ok = false;
    try {
      ok = document.execCommand("copy");
    } catch (e) {
      ok = false;
    }

    document.body.removeChild(ta);
    return ok;
  },

    showCopyHelper(text) {
    const existing = document.getElementById("copyHelperOverlay");
    if (existing) existing.remove();

        // L√•s toppkontroller medan kopieramodalen √§r √∂ppen
    this.lockTopControls();

    const wrap = document.createElement("div");
    wrap.id = "copyHelperOverlay";
    wrap.style.position = "fixed";
    wrap.style.inset = "0";
    wrap.style.background = "rgba(0,0,0,0.5)";
    wrap.style.zIndex = "9999";
    wrap.style.display = "flex";
    wrap.style.alignItems = "center";
    wrap.style.justifyContent = "center";
    wrap.style.padding = "16px";

    const box = document.createElement("div");
    box.style.background = "#fff";
    box.style.width = "min(720px, 100%)";
    box.style.maxHeight = "min(80vh, 100%)";
    box.style.borderRadius = "12px";
    box.style.padding = "12px";
    box.style.boxShadow = "0 10px 30px rgba(0,0,0,0.25)";
    box.style.display = "flex";
    box.style.flexDirection = "column";
    box.style.gap = "8px";

    const top = document.createElement("div");
    top.style.display = "flex";
    top.style.alignItems = "center";
    top.style.justifyContent = "space-between";
    top.style.gap = "12px";

    const title = document.createElement("div");
    title.textContent = "Kopiera listan";
    title.style.fontWeight = "600";

    const hint = document.createElement("div");
    hint.textContent = "Tryck Cmd+C (Mac) eller Ctrl+C (Windows) och st√§ng sedan.";
    hint.style.fontSize = "12px";
    hint.style.opacity = "0.8";

    const close = document.createElement("button");
    close.type = "button";
    close.textContent = "St√§ng";
    close.style.padding = "6px 10px";

    const ta = document.createElement("textarea");
    ta.value = text;
    ta.readOnly = true;
    ta.style.width = "100%";
    ta.style.flex = "1";
    ta.style.minHeight = "240px";
    ta.style.resize = "vertical";

    // Stabil kolumnk√§nsla i modalen
    ta.style.fontFamily =
      'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ta.style.fontVariantNumeric = "tabular-nums";

        const unlockControls = () => {
      this.unlockTopControls();
    };

    const closeModal = () => {
      wrap.remove();
      unlockControls();

      // N√§r man st√§nger kopieringsf√∂nstret: √•terg√• till nuvarande √•r i linj√§ra vyn
      if (!document.body.classList.contains("overview-mode") && this.selectedYear !== this.currentYear) {
        this.resetYearToCurrent();
      }

      // S√§tt tillbaka fokus s√• UI k√§nns ‚Äúklart‚Äù
      if (this.dom.copyBtn) this.dom.copyBtn.focus();
    };

    close.addEventListener("click", closeModal);

    // Klick p√• bakgrunden st√§nger (valfritt men stabilt)
    wrap.addEventListener("click", (e) => {
      if (e.target === wrap) closeModal();
    });

    top.appendChild(title);
    top.appendChild(close);

    box.appendChild(top);
    box.appendChild(hint);
    box.appendChild(ta);
    wrap.appendChild(box);
    document.body.appendChild(wrap);

    ta.focus();
    ta.select();
  },

  buildBirthdaysText() {
    const onlyBirthdays = true;

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.getBirthdayEvents().forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      if (onlyBirthdays && String(ev.type).toLowerCase() !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    const lines = [];
    lines.push(`F√∂delsedagar ‚Äì √Ör ${this.selectedYear}`);
    lines.push("");

    this.monthOrder.forEach((monthKey) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);
      lines.push(monthTitle);

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const paddedDay = day.padStart(2, " ");
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        const age = this.getBirthdayAgeText(ev.year);
        const ageText = age ? ` (${age})` : "";

        lines.push(`${paddedDay}\tüéÇ\t${name}${ageText}`);
      });

      lines.push("");
    });

    return lines.join("\n").trim();
  },

  buildPrintView() {
    const { printMeta, printWrap } = this.dom;
    if (!printMeta || !printWrap) return;

    const onlyBirthdays = true;

    printMeta.textContent = `√Ör: ${this.selectedYear}`;
    printWrap.innerHTML = "";
    const colLeft = document.createElement("div");
    colLeft.className = "print-col print-col-left";

    const colRight = document.createElement("div");
    colRight.className = "print-col print-col-right";

    printWrap.appendChild(colLeft);
    printWrap.appendChild(colRight);

    const byMonth = new Map();
    this.monthOrder.forEach((m) => byMonth.set(m, []));

    this.getBirthdayEvents().forEach((ev) => {
      if (!ev || !ev.month) return;
      const monthKey = String(ev.month).toLowerCase().trim();
      if (!byMonth.has(monthKey)) return;

      const evType = String(ev.type || "").toLowerCase();
      if (onlyBirthdays && evType !== "birthday") return;

      byMonth.get(monthKey).push(ev);
    });

    this.monthOrder.forEach((monthKey, idx) => {
      const monthEvents = byMonth.get(monthKey) || [];
      if (monthEvents.length === 0) return;

      monthEvents.sort((a, b) => (a.day || 0) - (b.day || 0));

      const monthTitle = monthKey.charAt(0).toUpperCase() + monthKey.slice(1);

      const monthDiv = document.createElement("div");
      monthDiv.className = "print-month";

      const h2 = document.createElement("h2");
      h2.textContent = monthTitle;

      const ul = document.createElement("ul");

      monthEvents.forEach((ev) => {
        const day = ev.day != null ? String(ev.day) : "";
        const paddedDay = day.padStart(2, " ");
        const name = ev.name != null ? String(ev.name) : "";
        if (!day || !name) return;

        const evType = String(ev.type || "").trim().toLowerCase();
        const icon = evType === "birthday" ? "üéÇ" : "";

        const age = evType === "birthday" ? this.getBirthdayAgeText(ev.year) : "";
        const ageText = age ? ` (${age})` : "";

         const li = document.createElement("li");
        li.className = "print-row";

        const daySpan = document.createElement("span");
        daySpan.className = "print-day";
        daySpan.textContent = paddedDay;

        const iconSpan = document.createElement("span");
        iconSpan.className = "print-icon";
        iconSpan.textContent = icon;

        const textSpan = document.createElement("span");
        textSpan.className = "print-text";
        textSpan.textContent = `${name}${ageText}`;

        li.appendChild(daySpan);
        li.appendChild(iconSpan);
        li.appendChild(textSpan);

        ul.appendChild(li);

      });

      if (ul.children.length === 0) return;

      monthDiv.appendChild(h2);
      monthDiv.appendChild(ul);

      if (idx <= 5) {
        colLeft.appendChild(monthDiv);
      } else {
        colRight.appendChild(monthDiv);
      }
    });
  },

  printBirthdaysOnly() {
  // Sp√§rra print n√§r overlay √§r √∂ppen
  if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;

  this.handleBeforePrint();
  window.print();
},
      resetPrintFlags() {
    document.body.classList.remove("print-birthdays-only");
    this._isPreparingPrint = false;

    if (this.dom.printWrap) this.dom.printWrap.innerHTML = "";

       // L√•s upp toppkontroller igen
    this.unlockTopControls();

    // Efter print: √•terg√• till nuvarande √•r (2026)
    this.resetYearToCurrent();
  },
 
    handleBeforePrint() {
    if (this._isPreparingPrint) return;
    this._isPreparingPrint = true;

        // L√•s toppkontroller under print (f√∂ruts√§gbart l√§ge)
    this.lockTopControls();

    // St√§ng overlay visuellt inf√∂r print
    if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) {
      this.dom.overlay.classList.add("hidden");
    }

    document.body.classList.add("print-birthdays-only");
    this.buildPrintView();
  },

  handleDocumentClick(event) {
   
    const dayButton = event.target.closest(".day-item");
    if (!dayButton) return;

    const hasDay = !!(dayButton.dataset && dayButton.dataset.day);
    const hasMonth = !!(dayButton.dataset && dayButton.dataset.month);
    if (!hasDay || !hasMonth) return;

    this.openOverlayFromButton(dayButton);
  },

  handleKeydown(event) {
    const { overlay } = this.dom;
    if (event.key === "Escape" && overlay) {
      this.closeOverlay();
    }
  },

 handleOverlayClick(event) {
  const { overlay } = this.dom;
  if (!overlay) return;

  // Klick p√• sj√§lva bakgrunden (inte inne i rutan)
  if (event.target === overlay) {
    event.preventDefault();
    event.stopPropagation();
    this.closeOverlay();
  }
},

  toggleOverview() {
    const willShow = !document.body.classList.contains("overview-mode");

    if (willShow) {
      document.body.classList.add("overview-mode");
      this.buildOverview();
    } else {
      document.body.classList.remove("overview-mode");
      this.resetYearToCurrent();
    }

    this.setOverviewButtonLabel();
  },

  resetYearToCurrent() {
    const { yearSelect } = this.dom;
    if (!yearSelect) return;

    yearSelect.value = String(this.currentYear);
    this.selectedYear = this.currentYear;
    this.updateAllAges();

    if (document.body.classList.contains("overview-mode")) {
      this.buildOverview();
    }
  },

   openOverlayFromButton(dayButton) {
  const { overlay, overlayTitle, overlayText, openSound } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  const monthKey = (dayButton.dataset.month || "").trim().toLowerCase();
  const month = monthKey ? monthKey.charAt(0).toUpperCase() + monthKey.slice(1) : "";

  const day = (dayButton.dataset.day || "").trim();
  const type = (dayButton.dataset.type || "").trim().toLowerCase();
  const id = (dayButton.dataset.id || "").trim();

  const birthYearRaw = dayButton.dataset.year;
  const name = (dayButton.dataset.name || "").trim();
  const text = (dayButton.dataset.text || "").trim();

  // Rubrik
  overlayTitle.textContent = day && month ? `${day} ${month}` : (month || "");

  const playOpenSound = () => {
    if (!openSound) return;
    try {
      openSound.currentTime = 0;
      openSound.play();
    } catch {}
  };

  // 1) Anv√§ndarh√§ndelse (event) med id -> visa detaljer + knappar
  if (type === "event" && id) {
    const ev = this.getUserEventById(id);

    const safe = (v) => (v == null ? "" : String(v));
    const title = safe(ev?.title || name);
    const date = safe(ev?.date || "");
    const time = safe(ev?.time || "");
    const place = safe(ev?.place || "");
    const desc = safe(ev?.desc || "");
    const createdBy = safe(ev?.createdBy || "");
    const icon = safe(ev?.icon || "");

    overlayText.innerHTML = `
      <div style="display:grid; gap:0.4rem;">
        <div><strong>${icon ? `${icon} ` : ""}${title}</strong></div>
        ${date ? `<div>Datum: ${date}</div>` : ``}
        ${time ? `<div>Tid: ${time}</div>` : ``}
        ${place ? `<div>Plats: ${place}</div>` : ``}
        ${desc ? `<div>Beskrivning: ${desc}</div>` : ``}
        ${createdBy ? `<div>Skapad av: ${createdBy}</div>` : ``}

        <div style="display:flex; gap:0.5rem; margin-top:0.6rem; justify-content:flex-end;">
          <button type="button" id="eventEditBtn">Redigera</button>
          <button type="button" id="eventDeleteBtn">Ta bort</button>
        </div>
      </div>
    `;

    // √ñppna + l√•s kontroller
    this.lockTopControls();
    overlay.classList.remove("hidden");
    playOpenSound();

    const editBtn = document.getElementById("eventEditBtn");
    const delBtn = document.getElementById("eventDeleteBtn");

    if (editBtn) {
      editBtn.addEventListener("click", () => {
        this.openEventCreateOverlay(ev); // √∂ppna i redigeringsl√§ge
      });
    }

    if (delBtn) {
      delBtn.addEventListener("click", () => {
        const ok = confirm("Ta bort h√§ndelsen?");
        if (!ok) return;

        this.deleteUserEventById(id);
        this.renderMonthsFromEvents();
        this.closeOverlay(); // st√§nger + l√•ser upp kontroller konsekvent
      });
    }

    return;
  }

  // 2) F√∂delsedag
  if (type === "birthday" && name) {
    const age = this.getBirthdayAgeText(birthYearRaw);
    overlayText.textContent = age ? `${name} fyller ${age}` : name;
  } else {
    // 3) √ñvrigt
    overlayText.textContent = text || name || "";
  }

  // √ñppna + l√•s kontroller
  this.lockTopControls();
  overlay.classList.remove("hidden");
  playOpenSound();
},

 openEventCreateOverlay(existingEvent = null) {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  const SIGN_KEY = "arshjul_last_signature_v1";
  const ICON_KEY = "arshjul_last_event_icon_v1";
  const prefs = App?.dataStore?.prefs;

  const lastSignature = (prefs?.getString(SIGN_KEY, "") || "").trim();
  const lastIcon = (prefs?.getString(ICON_KEY, "üóìÔ∏è") || "üóìÔ∏è").trim();

  const isEdit = !!(existingEvent && existingEvent.id);

  // √ñppna overlay
  overlay.classList.remove("hidden");
  overlayTitle.textContent = isEdit ? "Redigera h√§ndelse" : "Ny h√§ndelse";

  overlayText.innerHTML = `
    <form id="eventCreateForm" class="event-form" data-edit-id="${isEdit ? String(existingEvent.id) : ""}">
      <div class="event-field">
        <label for="eventTitle">Titel *</label>
        <input id="eventTitle" name="title" type="text" required />
      </div>

      <div class="event-field">
        <label for="eventDate">Datum *</label>
        <input id="eventDate" name="date" type="date" required />
      </div>

      <div class="event-field">
        <label for="eventTime">Tid</label>
        <input id="eventTime" name="time" type="time" step="60" />
      </div>

      <div class="event-field">
        <label for="eventPlace">Plats</label>
        <input id="eventPlace" name="place" type="text" />
      </div>

      <div class="event-field">
        <label for="eventDesc">Beskrivning</label>
        <textarea id="eventDesc" name="desc" rows="3"></textarea>
      </div>

      <div class="event-field">
        <label for="eventIcon">Typ av h√§ndelse</label>
        <select id="eventIcon" name="icon">
          <option value="üóìÔ∏è">üóìÔ∏è Neutral</option>
          <option value="üéâ">üéâ Festlig</option>
        </select>
      </div>

      <div class="event-field">
        <label for="eventCreatedBy">Skapad av *</label>
        <input id="eventCreatedBy" name="createdBy" type="text" required />
      </div>

      <div class="event-actions">
        <button type="button" id="eventCancelBtn">Avbryt</button>
        <button type="submit" id="eventSaveBtn" disabled>Spara</button>
      </div>
    </form>
  `;

  const form = document.getElementById("eventCreateForm");

  const titleEl = document.getElementById("eventTitle");
  const dateEl = document.getElementById("eventDate");
  const timeEl = document.getElementById("eventTime");
  const placeEl = document.getElementById("eventPlace");
  const descEl = document.getElementById("eventDesc");
  const iconEl = document.getElementById("eventIcon");
  const createdByEl = document.getElementById("eventCreatedBy");

  const cancelBtn = document.getElementById("eventCancelBtn");
  const saveBtn = document.getElementById("eventSaveBtn");

  // Prefill: redigera-l√§ge vinner, annars senaste val
  if (isEdit) {
    if (titleEl) titleEl.value = String(existingEvent.title || "");
    if (dateEl) dateEl.value = String(existingEvent.date || "");
    if (timeEl) timeEl.value = String(existingEvent.time || "");
    if (placeEl) placeEl.value = String(existingEvent.place || "");
    if (descEl) descEl.value = String(existingEvent.desc || "");
    if (createdByEl) createdByEl.value = String(existingEvent.createdBy || "");
    if (iconEl) iconEl.value = String(existingEvent.icon || "üóìÔ∏è") === "üéâ" ? "üéâ" : "üóìÔ∏è";
  } else {
    if (createdByEl) createdByEl.value = lastSignature;
    if (iconEl) iconEl.value = lastIcon === "üéâ" ? "üéâ" : "üóìÔ∏è";
  }

  const updateSaveEnabled = () => {
    const titleOk = (titleEl?.value || "").trim().length > 0;
    const dateOk = (dateEl?.value || "").trim().length > 0;
    const createdByOk = (createdByEl?.value || "").trim().length > 0;

    if (saveBtn) saveBtn.disabled = !(titleOk && dateOk && createdByOk);
  };

  [titleEl, dateEl, createdByEl].forEach((el) => {
    if (!el) return;
    el.addEventListener("input", updateSaveEnabled);
  });

  // Avbryt st√§nger overlay (anv√§nd samma st√§nglogik √∂verallt)
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  // Submit: skapa nytt eller uppdatera befintligt
  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const title = (titleEl?.value || "").trim();
      const date = (dateEl?.value || "").trim().replace(/\s+/g, "");
      const time = (timeEl?.value || "").trim();
      const place = (placeEl?.value || "").trim();
      const desc = (descEl?.value || "").trim();
      const icon = (iconEl?.value || "üóìÔ∏è").trim();
      const createdBy = (createdByEl?.value || "").trim();

      if (!title || !date || !createdBy) return;

      // Kom ih√•g senaste val
      try {
        prefs?.setString(SIGN_KEY, createdBy);
        prefs?.setString(ICON_KEY, icon === "üéâ" ? "üéâ" : "üóìÔ∏è");
      } catch {}

      const editId = (form.dataset.editId || "").trim();

      if (editId) {
        const updatedEvent = {
          id: editId, // <-- beh√•ll samma id
          title,
          date,
          time,
          place,
          desc,
          createdBy,
          icon
        };

        this.updateUserEvent(updatedEvent);
      } else {
        const newEvent = {
          id: `ev_${Date.now()}`,
          title,
          date,
          time,
          place,
          desc,
          createdBy,
          icon
        };

        this.addUserEvent(newEvent);
      }

      if (typeof this.renderMonthsFromEvents === "function") {
        this.renderMonthsFromEvents();
      }

      this.closeOverlay();
    });
  }

  updateSaveEnabled();
}, 
openExportEventsOverlay() {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  const data = this.getUserEvents();
  const json = JSON.stringify(data, null, 2);

  overlay.classList.remove("hidden");
  overlayTitle.textContent = "Exportera h√§ndelser";

  overlayText.innerHTML = `
    <div class="event-form" style="margin-top:0;">
      <div class="event-field">
        <label for="exportJson">Kopiera JSON</label>
        <textarea id="exportJson" rows="10" style="width:100%">${json}</textarea>
      </div>

      <div class="event-actions">
        <button type="button" id="exportCloseBtn">St√§ng</button>
      </div>
    </div>
  `;

  const ta = document.getElementById("exportJson");
  if (ta) {
    ta.focus();
    ta.select();
  }

  const closeBtn = document.getElementById("exportCloseBtn");
  if (closeBtn) {
    closeBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }
},

openImportEventsOverlay() {
  const { overlay, overlayTitle, overlayText } = this.dom;
  if (!overlay || !overlayTitle || !overlayText) return;

  this.lockTopControls();

  overlay.classList.remove("hidden");
  overlayTitle.textContent = "Importera h√§ndelser";

  overlayText.innerHTML = `
    <form id="importEventsForm" class="event-form">
      <div class="event-field">
        <label for="importJson">Klistra in JSON</label>
        <textarea id="importJson" rows="10" style="width:100%" placeholder='[{"id":"ev_...","title":"...","date":"YYYY-MM-DD",...}]'></textarea>
      </div>

      <div class="event-actions">
        <button type="button" id="importCancelBtn">Avbryt</button>
        <button type="submit" id="importSaveBtn">Importera</button>
      </div>
    </form>
  `;

  const cancelBtn = document.getElementById("importCancelBtn");
  if (cancelBtn) {
    cancelBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  const form = document.getElementById("importEventsForm");
  const input = document.getElementById("importJson");

  if (form) {
    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const raw = (input?.value || "").trim();
      if (!raw) return;

      let parsed;
      try {
        parsed = JSON.parse(raw);
      } catch {
        alert("Ogiltig JSON. Kontrollera att du klistrat in korrekt format.");
        return;
      }

      if (!Array.isArray(parsed)) {
        alert("JSON m√•ste vara en lista (array) av h√§ndelser.");
        return;
      }

      // Enkel validering + normalisering
      const cleaned = parsed
        .filter((ev) => ev && typeof ev === "object")
        .map((ev) => ({
          id: String(ev.id || `ev_${Date.now()}`),
          title: String(ev.title || "").trim(),
          date: String(ev.date || "").trim(),
          time: String(ev.time || "").trim(),
          place: String(ev.place || "").trim(),
          desc: String(ev.desc || "").trim(),
          createdBy: String(ev.createdBy || "").trim(),
          icon: String(ev.icon || "üóìÔ∏è").trim() === "üéâ" ? "üéâ" : "üóìÔ∏è"
        }))
        .filter((ev) => ev.title && ev.date && ev.createdBy);

      if (cleaned.length === 0) {
        alert("Inget att importera. Kontrollera att varje post har title, date och createdBy.");
        return;
      }

      // Sl√• ihop med befintliga (dedupe sker i getUserEvents)
      const current = this.getUserEvents();
      const merged = [...current, ...cleaned];
      this.setUserEvents(merged);

      this.renderMonthsFromEvents();
      this.closeOverlay();
      alert(`Importerade ${cleaned.length} h√§ndelser.`);
    });
  }
},

openExportBirthdaysPrompt() {
  const data = this.dataStore.birthdays.exportBirthdays();
  const json = JSON.stringify(data, null, 2);
  window.prompt("Kopiera JSON f√∂r f√∂delsedagar:", json);
},

openImportBirthdaysPrompt() {
  const raw = window.prompt('Klistra in birthdays JSON\nFormat: [{"name":"...","year":1990,"month":1,"day":1}]');
  if (raw == null) return;
  const trimmed = raw.trim();
  if (!trimmed) return;

  let parsed;
  try {
    parsed = JSON.parse(trimmed);
  } catch {
    alert("Ogiltig JSON. Kontrollera formatet.");
    return;
  }

  if (!Array.isArray(parsed)) {
    alert("JSON m√•ste vara en lista (array) med birthdays.");
    return;
  }

  const imported = this.dataStore.birthdays.importBirthdays(parsed);
  this.renderMonthsFromEvents();
  this.updateAllAges();
  if (document.body.classList.contains("overview-mode")) {
    this.buildOverview();
  }
  alert(`Importerade ${imported.length} f√∂delsedagar.`);
},

getUserEvents() {
  return this.dataStore.events.listEvents();
},

setUserEvents(events) {
  this.dataStore.events.replaceEvents(events);
},

addUserEvent(ev) {
  return this.dataStore.events.createEvent(ev);
},

getUserEventById(id) {
  const arr = this.getUserEvents();
  return arr.find((e) => e && e.id === id) || null;
},

updateUserEvent(updated) {
  if (!updated || String(updated.type || "event").toLowerCase() === "birthday") return false;
  return this.dataStore.events.updateEvent(updated.id, updated);
},

deleteUserEventById(id) {
  if (!id) return false;
  const ev = this.getUserEventById(id);
  if (ev && String(ev.type || "event").toLowerCase() === "birthday") return false;
  return this.dataStore.events.deleteEvent(id);
},

 closeOverlay() {
  const { overlay } = this.dom;
  if (!overlay) return;

  overlay.classList.add("hidden");
  this.unlockTopControls();

  if (!document.body.classList.contains("overview-mode") && this.selectedYear !== this.currentYear) {
    this.resetYearToCurrent();
  }
},

  bindEvents() {
  const {
    toggleOverviewBtn,
    closeBtn,
    overlay,
    printBtn,
    copyBtn,
    addEventBtn,
    exportEventsBtn,
    importEventsBtn,
    exportBirthdaysBtn,
    importBirthdaysBtn,
    exitAdminBtn,
    familyCodeInput,
    setFamilyCodeBtn
  } = this.dom;

  if (toggleOverviewBtn) {
    toggleOverviewBtn.addEventListener("click", () => {
      this.toggleOverview();
    });
  }

  if (addEventBtn) {
    addEventBtn.addEventListener("click", () => {
      this.openEventCreateOverlay();
    });
  }

  document.addEventListener("click", (event) => {
    this.handleDocumentClick(event);
  });

  if (closeBtn && overlay) {
    closeBtn.addEventListener("click", () => {
      this.closeOverlay();
    });
  }

  if (overlay) {
    overlay.addEventListener(
      "click",
      (event) => {
        this.handleOverlayClick(event);
      },
      true // capture: stoppar click-through s√§krare
    );
  }

  document.addEventListener("keydown", (event) => {
    this.handleKeydown(event);
  });

  window.addEventListener("beforeprint", () => {
    this.handleBeforePrint();
  });

  window.addEventListener("afterprint", () => {
    this.resetPrintFlags();
  });

  if (printBtn) {
    printBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.printBirthdaysOnly();
    });
  }

  if (copyBtn) {
    copyBtn.addEventListener("click", async () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;

      try {
        const text = this.buildBirthdaysText();
        const ok = await this.copyBirthdaysToClipboard();

        if (!ok) {
          this.showCopyHelper(text);
        }
      } catch (e) {
        console.error("Fel vid kopiering av f√∂delsedagslista:", e);
      }
    });
  }

  if (exportEventsBtn) {
    exportEventsBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openExportEventsOverlay();
    });
  }

  if (importEventsBtn) {
    importEventsBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openImportEventsOverlay();
    });
  }

  if (exportBirthdaysBtn) {
    exportBirthdaysBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openExportBirthdaysPrompt();
    });
  }

  if (importBirthdaysBtn) {
    importBirthdaysBtn.addEventListener("click", () => {
      if (this.dom.overlay && !this.dom.overlay.classList.contains("hidden")) return;
      this.openImportBirthdaysPrompt();
    });
  }

  if (exitAdminBtn) {
    exitAdminBtn.addEventListener("click", () => {
      this.exitAdminMode();
    });
  }

  if (setFamilyCodeBtn) {
    setFamilyCodeBtn.addEventListener("click", () => {
      this.setFamilyCode(familyCodeInput?.value || this.defaultFamilyCode);
    });
  }

  if (familyCodeInput) {
    familyCodeInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        this.setFamilyCode(familyCodeInput.value);
      }
    });
  }
},

  init() {
    this.selectedYear = this.currentYear;
    this.loadFamilyCode();
    this.cacheDom();
    this.applyAdminMode();

    if (this.dom.familyCodeInput) {
      this.dom.familyCodeInput.value = this.getCurrentFamilyCode();
    }

    this.renderMonthsFromEvents();

    this.bindEvents();
    this.initYearSelect();
    this.updateAllAges();
    this.setOverviewButtonLabel();
  }
};

window.addEventListener("load", () => {
  App.init();
});
</script>

<audio id="openSound" preload="none">
</audio>

</body>
</html>
